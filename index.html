<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TUMBLER - The Lockpick Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chivo+Mono:wght@400;700&family=Karnak+Pro:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* THEME: Premium Dark Heist */
            --bg-grad-start: #121212;
            --bg-grad-end: #1e293b;
            
            --safe-body: #1e293b;
            --safe-inset: #0f172a;
            --safe-border: #334155;
            
            /* UPDATED PALETTE */
            --color-correct: #6aaa64;  /* NYT Green */
            --color-close: #c9b458;    /* NYT Yellow */
            --color-far: #ef4444;      /* RED (Replaced Gray) */
            
            --text-color: #f8fafc;
            --key-bg: #334155;
            --key-text: #e2e8f0;
            --key-disabled: #0f172a; /* NEW: Darker shade for disabled keys */
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Chivo Mono', monospace;
            background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            height: auto;
            margin: 0;
            padding: 10px;
            user-select: none;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* --- HEADER --- */
        header {
            margin-top: 15px;
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 15px;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        h1 {
            margin: 0;
            font-family: serif;
            font-size: 2.2rem;
            letter-spacing: 1px;
            color: #fff;
            text-transform: capitalize;
            font-weight: 700;
        }

        .sub-text {
            font-size: 0.8rem;
            color: #94a3b8;
            letter-spacing: 1px;
            margin-top: 5px;
            text-transform: uppercase;
        }

        .stats-btn {
            position: absolute;
            top: 15px;
            right: 10px;
            background: var(--key-bg);
            color: var(--text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .stats-btn:hover {
            background: #475569;
        }

        .stats-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .stats-content {
            background: var(--safe-body);
            padding: 30px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-correct);
        }

        .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .close-stats {
            background: var(--color-correct);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            margin-top: 20px;
        }

        /* HOW TO PLAY MODAL */
        .tutorial-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .tutorial-content {
            background: var(--safe-body);
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .tutorial-content h2 {
            margin-top: 0;
            text-align: center;
            color: var(--color-correct);
        }

        .tutorial-content p {
            line-height: 1.6;
            color: #cbd5e1;
            margin: 15px 0;
        }

        .example-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .example-tile {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #475569, #1e293b);
            border: 2px solid #334155;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #cbd5e1;
            position: relative;
        }

        .example-tile.correct {
            border-color: var(--color-correct);
            color: var(--color-correct);
        }

        .example-tile.close {
            border-color: var(--color-close);
            color: var(--color-close);
        }

        .example-tile.far {
            border-color: var(--color-far);
            color: var(--color-far);
        }

        .example-arrow {
            font-size: 0.7rem;
            margin-top: 2px;
            color: inherit;
        }

        .tutorial-btn {
            background: var(--color-correct);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            margin-top: 20px;
            font-size: 1rem;
        }

        .tutorial-btn:hover {
            background: #5a9455;
        }

        .help-icon {
            position: absolute;
            top: 15px;
            left: 10px;
            background: var(--key-bg);
            color: var(--text-color);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-icon:hover {
            background: #475569;
        }

        /* --- GAME BOARD --- */
        #game-board {
            position: relative;
            padding: 20px;
            background: var(--safe-body);
            border-radius: 16px;
            box-shadow: 
                inset 0 1px 1px rgba(255, 255, 255, 0.1),
                0 20px 40px rgba(0, 0, 0, 0.5),
                0 0 0 1px var(--safe-border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 350px;
        }

        /* Safe Bolts */
        #game-board::before, #game-board::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #0f172a;
            border-radius: 50%;
            box-shadow: 0 1px 0 rgba(255,255,255,0.1);
        }
        #game-board::before { top: 10px; left: 10px; }
        #game-board::after { bottom: 10px; right: 10px; }

        .row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            background: var(--safe-inset);
            padding: 8px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.03);
            transition: all 0.3s ease;
        }
        
        .row.active {
            box-shadow: 0 0 0 1px rgba(255,255,255,0.15);
            background: #182234;
        }

        /* --- TUMBLERS (Dials) --- */
        .tile {
            width: 58px;
            height: 58px;
            border-radius: 50%; 
            background: 
                repeating-conic-gradient(
                    from 0deg,
                    #334155 0deg 3.46deg,
                    transparent 3.46deg 6.92deg
                ),
                radial-gradient(circle at 30% 30%, #475569, #1e293b);
            border: 2px solid #334155;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            font-weight: 700;
            position: relative;
            color: #cbd5e1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .tile::before {
            content: '';
            position: absolute;
            top: 4px;
            width: 4px;
            height: 6px;
            background: rgba(0,0,0,0.5);
            border-radius: 2px;
        }
        
        .tile::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at center, transparent 60%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0.3) 65%, transparent 65%);
            pointer-events: none;
        }

        .tile[data-status="filled"] {
            border-color: #94a3b8;
            color: #fff;
            transform: scale(1.05);
        }

        .letter { z-index: 2; margin-top: 2px; }

        /* --- INDICATORS --- */
        .indicator {
            font-size: 0.8rem;
            position: absolute;
            width: 100%;
            text-align: center;
            opacity: 0;
            font-weight: 700;
            transition: opacity 0.3s;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* --- FEEDBACK STATES --- */
        .tile.evaluated {
            transition: 
                transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1),
                background 0.3s,
                border-color 0.3s;
        }

        /* CORRECT (Green) */
        .tile.correct {
            border-color: var(--color-correct);
            color: var(--color-correct);
            box-shadow: 0 0 15px rgba(106, 170, 100, 0.2);
            transform: rotate(360deg);
            z-index: 1;
        }

        /* CLOSE (Yellow) */
        .tile.close {
            border-color: var(--color-close);
            color: var(--color-close);
            z-index: 2;
        }
        .tile.close.up { transform: rotate(15deg); }
        .tile.close.down { transform: rotate(-15deg); }
        .tile.close .indicator { 
            color: var(--color-close); 
            bottom: -20px;
        }

        /* FAR (RED - Updated) */
        .tile.far {
            border-color: var(--color-far);
            color: var(--color-far);
            opacity: 0.9;
            z-index: 3;
        }
        .tile.far.up { transform: rotate(30deg); }
        .tile.far.down { transform: rotate(-30deg); }
        .tile.far .indicator { 
            color: var(--color-far);
            bottom: -20px;
        }

        .tile.evaluated .indicator { opacity: 1; }

        /* --- KEYBOARD (A-Z Layout) --- */
        #keyboard {
            width: 100%;
            max-width: 600px;
            padding: 0 5px;
            margin-bottom: 10px;
        }

        .key-row {
            display: flex;
            width: 100%;
            margin: 0 auto 6px;
            gap: 4px;
            justify-content: center;
        }

        .key {
            font-family: 'Chivo Mono', monospace;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            background-color: var(--key-bg);
            color: var(--key-text);
            font-weight: 700;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            box-shadow: 0 3px 0 #0f172a;
            position: relative;
            font-size: 1rem;
            transition: opacity 0.1s, transform 0.1s, background-color 0.3s; /* Added opacity transition */
        }
        
        .key:active { transform: translateY(3px); box-shadow: none; }
        
        /* NEW: Disabled/Impossible Keys */
        .key[data-disabled="true"] {
            background-color: var(--key-disabled) !important;
            opacity: 0.3 !important;
            cursor: default;
            pointer-events: none !important;
        }

        .key::after {
            content: attr(data-value);
            position: absolute;
            top: 3px;
            right: 5px;
            font-size: 0.7rem;
            color: #64748b;
            font-weight: 700;
        }

        .key.wide { flex: 1.5; font-size: 0.8rem; }
        .key.wide::after { content: ''; }

        /* Key States - ONLY GREEN lights up now */
        .key.correct { 
            background-color: var(--color-correct); 
            color: #fff; 
            border: 1px solid rgba(255,255,255,0.2); 
            opacity: 1 !important; /* Ensure correct keys are never dimmed */
            pointer-events: auto !important;
        }
        /* No styling for .close or .far on keyboard as requested */


        /* --- LEGEND --- */
        .legend {
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
            margin-bottom: 15px;
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .legend-item { display: flex; align-items: center; gap: 6px; color: #cbd5e1; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        #message-container {
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
        }
        .toast {
            background: #f8fafc;
            color: #0f172a;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        @media (max-width: 600px) {
            body { padding: 5px; }
            .tile { width: 54px; height: 54px; font-size: 1.6rem; }
            .row { gap: 12px; padding: 6px; }
            h1 { font-size: 2rem; }
            #game-board { padding: 16px; max-width: 320px; }
            header { margin-top: 10px; margin-bottom: 10px; padding-bottom: 10px; }
        }

        @media (max-width: 480px) {
            body { padding: 5px; }
            .tile { width: 48px; height: 48px; font-size: 1.4rem; }
            .row { gap: 10px; padding: 6px; }
            #game-board { padding: 14px; max-width: 280px; }
            .key { height: 45px; font-size: 0.9rem; }
            .key-row { gap: 3px; margin-bottom: 5px; }
            h1 { font-size: 1.8rem; }
            .legend { font-size: 0.7rem; gap: 10px; padding: 6px 12px; margin-bottom: 10px; }
            header { margin-top: 8px; margin-bottom: 8px; }
        }

        @media (max-width: 380px) {
            body { padding: 3px; }
            .tile { width: 42px; height: 42px; font-size: 1.2rem; }
            .row { gap: 8px; padding: 5px; }
            #game-board { padding: 12px; max-width: 250px; }
            .key { height: 42px; font-size: 0.85rem; }
            .key::after { font-size: 0.6rem; }
            .key-row { gap: 2px; margin-bottom: 4px; }
            h1 { font-size: 1.6rem; }
            .legend { font-size: 0.65rem; gap: 8px; padding: 5px 10px; }
        }

        @media (max-width: 340px) {
            body { padding: 2px; }
            .tile { width: 38px; height: 38px; font-size: 1.1rem; }
            .row { gap: 6px; padding: 5px; }
            #game-board { padding: 10px; max-width: 220px; }
            .key { height: 40px; font-size: 0.8rem; }
            .key::after { font-size: 0.55rem; }
            h1 { font-size: 1.4rem; }
            .legend { font-size: 0.6rem; gap: 6px; padding: 4px 8px; }
        }

    </style>
</head>
<body>

    <header>
        <button class="help-icon" onclick="showTutorial()">?</button>
        <h1>Tumbler</h1>
        <div class="sub-text">Crack the code</div>
        <button class="stats-btn" onclick="showStats()">üìä Stats</button>
    </header>

    <div id="tutorial-modal" class="tutorial-modal">
        <div class="tutorial-content">
            <h2>üîê How To Play</h2>
            
            <p><strong>Crack the safe by guessing the 4-letter code!</strong></p>
            
            <p>Each guess shows you how close you are:</p>
            
            <div style="margin: 20px 0;">
                <p style="margin-bottom: 10px;"><strong>Example:</strong> If the code is <strong>LOCK</strong></p>
                
                <div class="example-row">
                    <div class="example-tile correct">L<div class="example-arrow">üîì</div></div>
                    <div class="example-tile close">P<div class="example-arrow">‚ñº</div></div>
                    <div class="example-tile far">B<div class="example-arrow">‚ñº‚ñº</div></div>
                    <div class="example-tile close">N<div class="example-arrow">‚ñ≤</div></div>
                </div>
                
                <ul style="text-align: left; color: #cbd5e1; line-height: 1.8;">
                    <li><span style="color: var(--color-correct);">üîì Green</span> = Correct letter, locked in!</li>
                    <li><span style="color: var(--color-close);">‚ñº Yellow</span> = Close (1-9 letters away)</li>
                    <li><span style="color: var(--color-far);">‚ñº‚ñº Red</span> = Far (10+ letters away)</li>
                    <li><strong>‚ñ≤ = Go higher</strong> in the alphabet</li>
                    <li><strong>‚ñº = Go lower</strong> in the alphabet</li>
                </ul>
            </div>
            
            <p><strong>üí° Pro Tip:</strong> Use the numbers on each key (A=1, B=2, Z=26) to navigate faster! **The keyboard will now automatically dim letters that are mathematically impossible based on previous clues!**</p>
            
            <p>You have <strong>6 attempts</strong> to crack the safe. Good luck! üéØ</p>
            
            <button class="tutorial-btn" onclick="closeTutorial()">Start Cracking! üîì</button>
        </div>
    </div>

    <div id="stats-modal" class="stats-modal">
        <div class="stats-content">
            <h2 style="margin-top:0; text-align:center;">Your Stats</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="stat-played">0</div>
                    <div class="stat-label">Played</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-winrate">0</div>
                    <div class="stat-label">Win %</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-streak">0</div>
                    <div class="stat-label">Streak üî•</div>
                </div>
            </div>
            <button class="close-stats" onclick="closeStats()">Close</button>
        </div>
    </div>

    <div id="message-container"></div>

    <div id="game-board">
        </div>

    <div class="legend">
        <div class="legend-item"><div class="dot" style="background:var(--color-far)"></div> Far (10+)</div>
        <div class="legend-item"><div class="dot" style="background:var(--color-close)"></div> Close (1-9)</div>
        <div class="legend-item"><div class="dot" style="background:var(--color-correct)"></div> Locked In</div>
    </div>

    <div id="keyboard"></div>

<script>
    const WORD_LIST = [
        "HAWK", "LION", "WOLF", "CART", "JUMP", "FISH", "BIRD", "CODE", "LOCK", "KEYS",
        "READ", "BLUE", "SOUL", "DARK", "MIND", "TIME", "PLAY", "GAME", "LOVE", "HOPE"
    ];

    const TARGET_WORD = WORD_LIST[Math.floor(Math.random() * WORD_LIST.length)];
    const WORD_LENGTH = 4;
    const MAX_TRIES = 6;
    const ASCII_A = 65;
    const ASCII_Z = 90;

    let currentRow = 0;
    let currentTile = 0;
    let guesses = Array(6).fill(null).map(() => Array(4).fill(""));
    let isGameOver = false;
    let startTime = Date.now();
    
    // NEW: Tracks the valid alphabet range (ASCII 65=A, 90=Z) for each slot.
    let slotConstraints = [
        { min: ASCII_A, max: ASCII_Z },
        { min: ASCII_A, max: ASCII_Z },
        { min: ASCII_A, max: ASCII_Z },
        { min: ASCII_A, max: ASCII_Z }
    ];

    const board = document.getElementById('game-board');
    const keyboardContainer = document.getElementById('keyboard');
    const messageContainer = document.getElementById('message-container');

    // Load stats from localStorage
    let stats = JSON.parse(localStorage.getItem('tumblerStats') || '{"played":0,"won":0,"currentStreak":0,"maxStreak":0,"guessDistribution":[0,0,0,0,0,0]}');

    function initGame() {
        console.log("Target Word:", TARGET_WORD);
        createBoard();
        createKeyboard();
        document.addEventListener('keydown', handleKeydown);
        updateActiveRow();
        updateKeyboardVisuals(); // Initial call to ensure all keys are enabled
        
        // Show tutorial on first visit
        if (!localStorage.getItem('tumblerTutorialSeen')) {
            showTutorial();
            localStorage.setItem('tumblerTutorialSeen', 'true');
        }
    }

    function createBoard() {
        for (let r = 0; r < MAX_TRIES; r++) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('row');
            rowDiv.setAttribute('id', `row-${r}`);
            
            for (let c = 0; c < WORD_LENGTH; c++) {
                const tileDiv = document.createElement('div');
                tileDiv.classList.add('tile');
                tileDiv.setAttribute('id', `row-${r}-tile-${c}`);
                
                const letterSpan = document.createElement('span');
                letterSpan.classList.add('letter');
                tileDiv.appendChild(letterSpan);

                const indicatorSpan = document.createElement('span');
                indicatorSpan.classList.add('indicator');
                tileDiv.appendChild(indicatorSpan);

                rowDiv.appendChild(tileDiv);
            }
            board.appendChild(rowDiv);
        }
    }

    function updateActiveRow() {
        document.querySelectorAll('.row').forEach(row => row.classList.remove('active'));
        if (!isGameOver && currentRow < MAX_TRIES) {
            const row = document.getElementById(`row-${currentRow}`);
            if(row) row.classList.add('active');
        }
    }
    
    function createKey(content, className) {
        const button = document.createElement('button');
        button.textContent = content;
        button.classList.add('key');
        if (className) button.classList.add(className);
        if (!className && content.length === 1) {
            // Store the A=1, B=2, Z=26 value for comparison
            button.setAttribute('data-value', content.charCodeAt(0) - ASCII_A + 1); 
        }
        return button;
    }

    function createKeyboard() {
        // ... (Keyboard structure remains the same) ...
        const rows = [
            "ABCDEFGHIJ",
            "KLMNOPQRST",
            "UVWXYZ"
        ];
        rows.forEach((rowString, index) => {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('key-row');
            
            if (index === 2) {
                const enterKey = createKey("ENTER", "wide");
                enterKey.onclick = submitGuess;
                rowDiv.appendChild(enterKey);
            }

            for (let char of rowString) {
                const key = createKey(char, "");
                key.id = `key-${char}`;
                key.onclick = () => {
                    if (!isGameOver && currentTile < WORD_LENGTH) {
                        addLetter(char);
                    }
                };
                rowDiv.appendChild(key);
            }

            if (index === 2) {
                const backKey = createKey("‚å´", "wide");
                backKey.onclick = deleteLetter;
                rowDiv.appendChild(backKey);
            }
            keyboardContainer.appendChild(rowDiv);
        });
    }

    // NEW FUNCTION: Updates the keyboard appearance based on constraints for the current tile
    function updateKeyboardVisuals() {
        // If row is complete or game is over, keep all keys active (unless already 'correct')
        if (isGameOver || currentRow >= MAX_TRIES) return;
        
        if (currentTile >= WORD_LENGTH) {
             document.querySelectorAll('.key').forEach(k => {
                k.removeAttribute('data-disabled'); // Re-enable all (except correct ones) for submit focus
            });
            return;
        }

        const range = slotConstraints[currentTile];

        document.querySelectorAll('.key').forEach(key => {
            // Only check alphabet keys
            if (key.classList.contains('wide') || key.classList.contains('correct')) return;

            // Use the ASCII value for comparison (A=65, B=66...)
            const keyVal = key.textContent.charCodeAt(0);

            if (keyVal < range.min || keyVal > range.max) {
                // INVALID KEY: Disable and dim
                key.setAttribute('data-disabled', 'true');
            } else {
                // VALID KEY: Enable
                key.removeAttribute('data-disabled');
            }
        });
    }


    function addLetter(letter) {
        if (isGameOver) return;
        if (currentTile >= WORD_LENGTH) return; 
        
        // Check if the letter is currently disabled by constraints
        const keyEl = document.getElementById(`key-${letter}`);
        if(keyEl && keyEl.hasAttribute('data-disabled')) {
            showMessage("Invalid letter for this position!");
            return;
        }

        guesses[currentRow][currentTile] = letter;
        const tile = document.getElementById(`row-${currentRow}-tile-${currentTile}`);
        
        if (!tile) {
            console.error('Tile not found:', currentRow, currentTile);
            return;
        }
        
        tile.querySelector('.letter').textContent = letter;
        tile.setAttribute('data-status', 'filled');
        currentTile++;
        
        // NEW: Update keyboard for the next tile immediately
        updateKeyboardVisuals(); 
    }

    function deleteLetter() {
        if (isGameOver) return;
        if (currentTile > 0) {
            currentTile--;
            guesses[currentRow][currentTile] = "";
            const tile = document.getElementById(`row-${currentRow}-tile-${currentTile}`);
            tile.querySelector('.letter').textContent = "";
            tile.removeAttribute('data-status');
            
            // NEW: Update keyboard for the now-active tile
            updateKeyboardVisuals(); 
        }
    }

    function showMessage(msg) {
        messageContainer.innerHTML = `<div class="toast">${msg}</div>`;
        setTimeout(() => messageContainer.innerHTML = '', 2000);
    }

    function submitGuess() {
        if (isGameOver) return;
        if (currentTile < WORD_LENGTH) {
            showMessage("Need full combination!");
            return;
        }
        evaluateGuess(guesses[currentRow]);
    }

    function evaluateGuess(guessArr) {
        const targetArr = TARGET_WORD.split("");
        let correctCount = 0;

        for (let i = 0; i < WORD_LENGTH; i++) {
            const tile = document.getElementById(`row-${currentRow}-tile-${i}`);
            const indicator = tile.querySelector('.indicator');
            const letter = guessArr[i];
            
            const guessVal = letter.charCodeAt(0); // ASCII 65-90
            const targetVal = targetArr[i].charCodeAt(0); // ASCII 65-90
            const diff = targetVal - guessVal;
            
            const key = document.getElementById(`key-${letter}`);

            // NEW: CONSTRAINTS UPDATE (This runs BEFORE the animation)
            if (diff > 0) {
                // Target is higher (‚ñ≤) -> The minimum possible value for this slot becomes Guess + 1
                slotConstraints[i].min = Math.max(slotConstraints[i].min, guessVal + 1);
            } else if (diff < 0) {
                // Target is lower (‚ñº) -> The maximum possible value for this slot becomes Guess - 1
                slotConstraints[i].max = Math.min(slotConstraints[i].max, guessVal - 1);
            } else {
                // Correct -> Lock the range to this letter only
                slotConstraints[i].min = guessVal;
                slotConstraints[i].max = guessVal;
            }

            setTimeout(() => {
                tile.classList.add('evaluated');

                if (diff === 0) {
                    tile.classList.add('correct');
                    correctCount++;
                    if(key) key.classList.add('correct');
                } else {
                    let symbol = "";
                    let distClass = "";
                    let rotateClass = diff > 0 ? "up" : "down"; 
                    
                    if (Math.abs(diff) > 9) {
                        distClass = "far"; 
                        symbol = diff > 0 ? "‚ñ≤‚ñ≤" : "‚ñº‚ñº";
                    } else {
                        distClass = "close"; 
                        symbol = diff > 0 ? "‚ñ≤" : "‚ñº";
                    }

                    tile.classList.add(distClass);
                    tile.classList.add(rotateClass); 
                    indicator.innerHTML = symbol;
                }
            }, i * 200); 
        }

        setTimeout(() => {
            if (correctCount === WORD_LENGTH) {
                // ... (Win animation code remains the same) ...
                const currentRowEl = document.getElementById(`row-${currentRow}`);
                currentRowEl.style.borderColor = "#6aaa64";
                currentRowEl.style.boxShadow = "0 0 30px rgba(106, 170, 100, 0.6)";
                
                for (let i = 0; i < WORD_LENGTH; i++) {
                    const tile = document.getElementById(`row-${currentRow}-tile-${i}`);
                    setTimeout(() => {
                        tile.style.transform = "rotate(720deg) scale(1.2)";
                        tile.style.boxShadow = "0 0 20px rgba(106, 170, 100, 0.8)";
                    }, i * 100);
                }
                
                setTimeout(() => {
                    const solveTime = Math.floor((Date.now() - startTime) / 1000);
                    stats.played++;
                    stats.won++;
                    stats.currentStreak++;
                    stats.maxStreak = Math.max(stats.maxStreak, stats.currentStreak);
                    stats.guessDistribution[currentRow]++;
                    localStorage.setItem('tumblerStats', JSON.stringify(stats));
                    
                    showMessage(`üéâ VAULT BREACHED in ${currentRow + 1}! Time: ${solveTime}s üéâ`);
                }, 400);
                
                isGameOver = true;
            } else {
                if (currentRow < MAX_TRIES - 1) {
                    currentRow++;
                    currentTile = 0;
                    updateActiveRow();
                    // NEW: Update keyboard for the new, first tile of the next row
                    updateKeyboardVisuals(); 
                } else {
                    stats.played++;
                    stats.currentStreak = 0;
                    localStorage.setItem('tumblerStats', JSON.stringify(stats));
                    showMessage(`üö® ALARM! Code was: ${TARGET_WORD}`);
                    isGameOver = true;
                }
            }
        }, WORD_LENGTH * 200 + 300);
    }

    function handleKeydown(e) {
        const key = e.key.toUpperCase();
        if (key === "ENTER") submitGuess();
        else if (key === "BACKSPACE") deleteLetter();
        else if (/^[A-Z]$/.test(key)) addLetter(key);
    }
    
    // ... (Modal functions remain the same) ...
    function showStats() {
        const modal = document.getElementById('stats-modal');
        modal.style.display = 'flex';
        
        document.getElementById('stat-played').textContent = stats.played;
        document.getElementById('stat-winrate').textContent = stats.played > 0 ? Math.round((stats.won / stats.played) * 100) : 0;
        document.getElementById('stat-streak').textContent = stats.currentStreak;
    }

    function closeStats() {
        document.getElementById('stats-modal').style.display = 'none';
    }

    function showTutorial() {
        document.getElementById('tutorial-modal').style.display = 'flex';
    }

    function closeTutorial() {
        document.getElementById('tutorial-modal').style.display = 'none';
    }

    // Close modal on outside click
    document.getElementById('stats-modal').addEventListener('click', (e) => {
        if (e.target.id === 'stats-modal') closeStats();
    });

    document.getElementById('tutorial-modal').addEventListener('click', (e) => {
        if (e.target.id === 'tutorial-modal') closeTutorial();
    });

    initGame();
</script>

</body>
</html>