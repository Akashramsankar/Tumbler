<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="HandheldFriendly" content="true" />

    <title>TUMBLER - The Lockpick Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Chivo+Mono:wght@400;700&family=Karnak+Pro:wght@700&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
      :root {
        /* THEME: Premium Dark Heist */
        --bg-grad-start: #121212;
        --bg-grad-end: #1e293b;

        --safe-body: #1e293b;
        --safe-inset: #0f172a;
        --safe-border: #334155;

        /* UPDATED PALETTE */
        --color-correct: #6aaa64; /* NYT Green */
        --color-close: #c9b458; /* NYT Yellow */
        --color-far: #ef4444; /* RED (Replaced Gray) */

        --text-color: #f8fafc;
        --key-bg: #334155;
        --key-text: #e2e8f0;
        --key-disabled: #0f172a; /* NEW: Darker shade for disabled keys */

        /* NEW: Cash Color */
        --color-cash: #00ff6a;
      }

      * {
        box-sizing: border-box;
        touch-action: manipulation;
      }

      html,
      body {
        touch-action: manipulation; 
        -ms-touch-action: manipulation;
      }

      body {
        font-family: "Chivo Mono", monospace;
        background: linear-gradient(
          135deg,
          var(--bg-grad-start) 0%,
          var(--bg-grad-end) 100%
        );
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        height: auto;
        margin: 0;
        padding: 10px;
        user-select: none;
        overflow-x: hidden;
        overflow-y: auto;
      }

      /* --- HEADER --- */
      header {
        margin-top: 15px;
        text-align: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #334155;
        padding-bottom: 15px;
        width: 100%;
        max-width: 500px;
        position: relative;
      }

      h1 {
        margin: 0;
        font-family: serif;
        font-size: 2.2rem;
        letter-spacing: 1px;
        color: #fff;
        text-transform: capitalize;
        font-weight: 700;
        padding-top: 10px; /* ADD THIS LINE */
      }

      .sub-text {
        font-size: 0.8rem;
        color: #94a3b8;
        letter-spacing: 1px;
        margin-top: 5px;
        text-transform: uppercase;
        margin-bottom: 10px; /* ADD THIS LINE */
      }

      .stats-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000; /* Keep this */
        justify-content: center;
        align-items: center;
      }

      .tutorial-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .stats-modal.active {
        pointer-events: auto; /* ADD THIS - enables clicks when visible */
      }

      .stats-content {
        background: var(--safe-body);
        padding: 30px;
        border-radius: 16px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        text-align: center; /* Center content in modal */
      }

      /* NEW: Stash Display */
      .stash-display {
        background: var(--safe-inset);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid var(--safe-border);
      }

      .stash-label {
        font-size: 0.9rem;
        color: #94a3b8;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .stash-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--color-cash);
        text-shadow: 0 0 10px rgba(0, 255, 106, 0.4);
      }

      .stats-btn {
        position: absolute;
        top: 15px;
        right: 10px;
        background: var(--key-bg);
        color: var(--text-color);
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 700;
      }

      .stats-btn:hover {
        background: #475569;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
        padding-top: 15px;
        border-top: 1px solid var(--safe-border);
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-correct);
      }

      .stat-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
      }

      .close-stats {
        background: var(--color-correct);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 700;
        width: 100%;
        margin-top: 20px;
      }

      .timer-display {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        font-size: 0.85rem;
        color: #94a3b8;
        font-family: "Chivo Mono", monospace;
        letter-spacing: 0.5px;
        padding: 4px 12px;
        background: rgba(15, 23, 42, 0.6);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        justify-content: center;
        transition: all 0.3s ease;
      }

      .timer-display.warning {
        color: var(--color-close);
        border-color: var(--color-close);
        animation: pulse 2s ease-in-out infinite;
      }

      .timer-display.danger {
        color: var(--color-far);
        border-color: var(--color-far);
        animation: pulse 1s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.02);
        }
      }

      .timer-icon {
        width: 14px;
        height: 14px;
        color: inherit;
      }

      #timer {
        font-weight: 700;
        color: inherit;
        min-width: 45px;
        text-align: center;
      }

      .tutorial-content {
        /* Glass/Metal Heist Look */
        background: linear-gradient(160deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 0 1px #0f172a, 0 20px 50px rgba(0, 0, 0, 0.9);
        padding: 24px;
        max-width: 420px;
        width: 90%;
        border-radius: 16px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      /* Add a subtle top highlight */
      .tutorial-content::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
      }

      .mission-header {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
      }

      .mission-title {
        color: #fff;
        font-family: serif;
        font-size: 1.8rem;
        letter-spacing: 1px;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .mission-subtitle {
        color: var(--color-correct); /* Green */
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 3px;
        font-weight: 700;
        opacity: 0.9;
        margin-top: 5px;
      }

      /* Recessed panel for examples */
      .example-set {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px 10px;
        background: rgba(0, 0, 0, 0.3); /* Darker recess */
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
      }

      .example-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        text-align: center;
        flex: 1;
      }

      .example-caption {
        font-size: 0.7rem;
        color: #94a3b8;
        line-height: 1.3;
        font-family: "Chivo Mono", monospace;
      }

      /* Information Grid */
      .rule-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 25px;
        padding: 0 5px;
      }

      .rule-line {
        display: flex;
        align-items: flex-start; /* Align top */
        gap: 12px;
        font-size: 0.9rem;
        color: #cbd5e1;
        line-height: 1.4;
      }

      .icon-box {
        color: var(--key-text);
        min-width: 20px;
        font-size: 1rem;
        text-align: center;
        margin-top: 1px; /* Optical alignment */
      }

      /* --- THE NEW BUTTON (Green Tile Style) --- */
      .tutorial-btn {
        background-color: var(--color-correct); /* #6aaa64 */
        color: white;
        border: none;
        border-radius: 4px;
        padding: 16px;
        font-size: 1.1rem;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
        cursor: pointer;
        /* 3D Key Effect */
        box-shadow: 0 4px 0 #538d4e, 0 5px 10px rgba(0, 0, 0, 0.3);
        transition: all 0.1s ease;
        width: 100%;
        margin-top: auto;
        font-family: "Chivo Mono", monospace;
      }

      .tutorial-content .tutorial-btn {
        font-size: 0.95rem;
        padding: 12px;
        margin-top: 20px;
      }

      /* Better Hover: Brightens slightly, no color swap */
      .tutorial-btn:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
      }

      /* Active: Pressed down effect */
      .tutorial-btn:active {
        transform: translateY(4px);
        box-shadow: 0 0 0 #538d4e; /* Shadow disappears */
      }

      .help-icon {
        position: absolute;
        top: 15px;
        left: 10px;
        background: var(--key-bg);
        color: var(--text-color);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }

      .help-icon:hover {
        background: #475569;
      }

      /* Timer display positioning */
      .timer-display {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 8px auto 0; /* CHANGE THIS LINE - added auto margins */
        font-size: 0.85rem;
        color: #94a3b8;
        font-family: "Chivo Mono", monospace;
        letter-spacing: 0.5px;
        padding: 4px 12px;
        background: rgba(15, 23, 42, 0.6);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        justify-content: center;
        width: fit-content; /* ADD THIS */
        transition: all 0.3s ease;
      }
      .countdown-display {
        background: var(--safe-inset);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 15px;
        border: 1px solid var(--safe-border);
        text-align: center;
        width: 100%;
        max-width: 350px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .countdown-label {
        font-size: 0.8rem;
        color: #94a3b8;
        text-transform: uppercase;
        margin-bottom: 8px;
        letter-spacing: 1px;
      }

      .countdown-timer {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--color-cash);
        font-family: "Chivo Mono", monospace;
        text-shadow: 0 0 10px rgba(0, 255, 106, 0.3);
      }

      .streak-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: rgba(239, 68, 68, 0.2);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        color: #fbbf24;
        margin-top: 10px;
        border: 1px solid rgba(251, 191, 36, 0.3);
      }

      .intel-tool {
        display: flex;
        justify-content: center;
      }

      .intel-btn {
        background: var(--key-bg);
        color: var(--text-color);
        border: 2px solid var(--color-close);
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 700;
        font-family: "Chivo Mono", monospace;
        transition: all 0.2s;
        text-align: center;
        min-width: 180px;
      }

      .intel-btn:hover:not(:disabled) {
        background: #475569;
        border-color: var(--color-correct);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(201, 180, 88, 0.3);
      }

      .intel-btn:disabled {
        cursor: default;
        opacity: 0.6;
        border-color: var(--safe-border);
      }

      /* --- CALENDAR STYLES --- */

      /* --- CALENDAR BUTTON STYLE --- */
      .calendar-btn {
        position: absolute;
        top: 15px;
        left: 55px; /* Spaced to the right of the help icon */
        background: var(--key-bg);
        color: var(--text-color);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px; /* Square with rounded corners looks better for calendar */
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }

      .calendar-btn:hover {
        background: #475569;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr); /* 5 days per row */
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
        padding: 5px;
      }

      .cal-day {
        background: var(--key-bg);
        aspect-ratio: 1;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 1px solid transparent;
        position: relative;
        font-size: 0.9rem;
        font-weight: 700;
      }

      .cal-day:hover {
        transform: scale(1.05);
        background: #475569;
      }
      .cal-day.future {
        opacity: 0.3;
        pointer-events: none;
      }
      .cal-day.current {
        border-color: #fff;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }

      /* Status Colors */
      .cal-day.won {
        background: var(--color-correct);
        color: #fff;
      }
      .cal-day.lost {
        background: var(--color-far);
        color: #fff;
      }
      .cal-day.played {
        background: var(--safe-border);
      } /* Started but not finished */

      .cal-number {
        font-size: 1.1rem;
      }
      .cal-money {
        font-size: 0.6rem;
        margin-top: 2px;
        opacity: 0.9;
      }

      /* --- GAME BOARD --- */
      #game-board {
        position: relative;
        padding: 20px;
        background: var(--safe-body);
        border-radius: 16px;
        box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1),
          0 20px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--safe-border);
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
        width: 100%;
        max-width: 350px;
      }

      /* Safe Bolts */
      #game-board::before,
      #game-board::after {
        content: "";
        position: absolute;
        width: 8px;
        height: 8px;
        background: #0f172a;
        border-radius: 50%;
        box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1);
      }
      #game-board::before {
        top: 10px;
        left: 10px;
      }
      #game-board::after {
        bottom: 10px;
        right: 10px;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        background: var(--safe-inset);
        padding: 8px;
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        transition: all 0.3s ease;
      }

      .row.active {
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.15);
        background: #182234;
      }

      /* --- TUMBLERS (Dials) --- */
      .tile {
        width: 58px;
        height: 58px;
        border-radius: 50%;
        background: repeating-conic-gradient(
            from 0deg,
            #334155 0deg 3.46deg,
            transparent 3.46deg 6.92deg
          ),
          radial-gradient(circle at 30% 30%, #475569, #1e293b);
        border: 2px solid #334155;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 1.8rem;
        font-weight: 700;
        position: relative;
        color: #cbd5e1;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .tile::before {
        content: "";
        position: absolute;
        top: 4px;
        width: 4px;
        height: 6px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 2px;
      }

      .tile::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: radial-gradient(
          circle at center,
          transparent 60%,
          rgba(0, 0, 0, 0.3) 60%,
          rgba(0, 0, 0, 0.3) 65%,
          transparent 65%
        );
        pointer-events: none;
      }

      .tile[data-status="filled"] {
        border-color: #94a3b8;
        color: #fff;
        transform: scale(1.05);
      }

      .letter {
        z-index: 2;
        margin-top: 2px;
      }

      /* --- INDICATORS --- */
      .indicator {
        font-size: 0.8rem;
        position: absolute;
        width: 100%;
        text-align: center;
        opacity: 0;
        font-weight: 700;
        transition: opacity 0.3s;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      }

      .distribution-bars {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .distribution-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .distribution-label {
        font-size: 0.9rem;
        font-weight: 700;
        width: 15px;
        text-align: right;
      }

      .distribution-bar {
        background: var(--safe-inset);
        height: 24px;
        min-width: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 700;
        transition: width 0.3s ease;
      }

      .distribution-bar.current {
        background: var(--color-correct);
        color: #fff;
      }

      /* --- FEEDBACK STATES --- */
      .tile.evaluated {
        transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1),
          background 0.3s, border-color 0.3s;
      }

      /* CORRECT (Green) */
      .tile.correct {
        border-color: var(--color-correct);
        color: var(--color-correct);
        box-shadow: 0 0 15px rgba(106, 170, 100, 0.2);
        transform: rotate(360deg);
        z-index: 1;
      }

      /* CLOSE (Yellow) */
      .tile.close {
        border-color: var(--color-close);
        color: var(--color-close);
        z-index: 2;
      }
      .tile.close.up {
        transform: rotate(15deg);
      }
      .tile.close.down {
        transform: rotate(-15deg);
      }
      .tile.close .indicator {
        color: var(--color-close);
        bottom: -20px;
      }

      /* FAR (RED - Updated) */
      .tile.far {
        border-color: var(--color-far);
        color: var(--color-far);
        opacity: 0.9;
        z-index: 3;
      }
      .tile.far.up {
        transform: rotate(30deg);
      }
      .tile.far.down {
        transform: rotate(-30deg);
      }
      .tile.far .indicator {
        color: var(--color-far);
        bottom: -20px;
      }

      .tile.evaluated .indicator {
        opacity: 1;
      }

      /* --- KEYBOARD (A-Z Layout) --- */
      #keyboard {
        width: 100%;
        max-width: 600px;
        padding: 0 5px;
        margin-bottom: 10px;
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
      }

      .key-row {
        display: flex;
        width: 100%;
        margin: 0 auto 6px;
        gap: 4px;
        justify-content: center;
      }

      .key {
        font-family: "Chivo Mono", monospace;
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 50px;
        background-color: var(--key-bg);
        color: var(--key-text);
        font-weight: 700;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        box-shadow: 0 3px 0 #0f172a;
        position: relative;
        font-size: 1rem;
        transition: opacity 0.1s, transform 0.1s, background-color 0.3s;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      .key:focus {
        outline: none;
      }

      .key:active {
        transform: translateY(3px);
        box-shadow: none;
      }

      /* NEW: Disabled/Impossible Keys */
      .key[data-disabled="true"] {
        background-color: var(--key-disabled) !important;
        opacity: 0.3 !important;
        cursor: default;
        pointer-events: none !important;
      }

      .key::after {
        content: attr(data-value);
        position: absolute;
        top: 3px;
        right: 5px;
        font-size: 0.7rem;
        color: #64748b;
        font-weight: 700;
      }

      /* MODIFIED: Increased flex to make Backspace/Enter larger */
      .key.wide {
        flex: 2.2;
        font-size: 1.2rem;
      }
      .key.wide::after {
        content: "";
      }

      /* Key States */
      .key.correct {
        background-color: var(--color-correct);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        opacity: 1 !important;
        pointer-events: auto !important;
      }

      /* --- LEGEND --- */
      .legend {
        display: flex;
        gap: 15px;
        font-size: 0.75rem;
        margin-bottom: 15px;
        background: rgba(15, 23, 42, 0.8);
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        color: #cbd5e1;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .keyboard-toggle {
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
        width: 100%;
        max-width: 600px;
      }

      .keyboard-toggle-btn {
        background: var(--key-bg);
        color: var(--text-color);
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 700;
        font-family: "Chivo Mono", monospace;
        transition: all 0.2s;
      }

      .keyboard-toggle-btn:hover {
        background: #475569;
      }

      #message-container {
        min-height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 5px;
        width: 100%;
        max-width: 500px;
      }
      .toast {
        background: #f8fafc;
        color: #0f172a;
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: 700;
        font-size: 0.9rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      }

      /* --- LEADERBOARD STYLES --- */
      .group-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .group-content {
        background: var(--safe-body);
        border: 1px solid var(--safe-border);
        padding: 25px;
        border-radius: 16px;
        max-width: 450px;
        width: 95%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        max-height: 90vh;
        overflow-y: auto;
      }

      .tab-container {
        display: flex;
        margin-bottom: 20px;
        background: var(--safe-inset);
        padding: 4px;
        border-radius: 8px;
      }

      .tab-btn {
        flex: 1;
        background: transparent;
        border: none;
        color: #94a3b8;
        padding: 10px;
        font-family: "Chivo Mono", monospace;
        font-weight: 700;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .tab-btn.active {
        background: var(--key-bg);
        color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .group-input {
        width: 100%;
        padding: 12px;
        background: var(--safe-inset);
        border: 1px solid var(--safe-border);
        color: #fff;
        border-radius: 6px;
        margin-bottom: 15px;
        font-family: "Chivo Mono", monospace;
        font-size: 1rem;
      }

      .lb-row {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .lb-rank {
        font-size: 1.2rem;
        font-weight: 700;
        width: 30px;
        color: #94a3b8;
      }
      .lb-rank.top-1 {
        color: #fbbf24;
      }
      .lb-rank.top-2 {
        color: #e2e8f0;
      }
      .lb-rank.top-3 {
        color: #b45309;
      }

      .lb-user {
        flex: 1;
        font-weight: 700;
      }

      .lb-score {
        text-align: right;
        font-weight: 700;
      }
      .lb-score-main {
        color: var(--color-cash);
      }
      .lb-score-sub {
        font-size: 0.75rem;
        color: #94a3b8;
      }

      .group-action-btn {
        background: var(--color-correct);
        color: white;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 10px;
      }
      .group-action-btn.secondary {
        background: var(--key-bg);
        margin-top: 10px;
      }

      /* ==================== CREW BADGES ==================== */
      .badge {
        display: inline-block;
        font-size: 1.1rem;
        margin-left: 4px;
        vertical-align: middle;
      }

      .badge-showcase {
        background: var(--safe-inset);
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid var(--safe-border);
      }

      .showcase-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        text-align: center;
      }

      .user-badges {
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .user-badge-item {
        background: rgba(106, 170, 100, 0.15);
        border: 1px solid var(--color-correct);
        border-radius: 8px;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
      }

      .user-badge-icon {
        font-size: 1.3rem;
      }

      .user-badge-name {
        font-weight: 700;
        color: var(--text-color);
      }

      .weekly-reset-timer {
        text-align: center;
        font-size: 0.7rem;
        color: #94a3b8;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid var(--safe-border);
      }

      @media (max-width: 600px) {
        body {
          padding: 5px;
        }
        .tile {
          width: 54px;
          height: 54px;
          font-size: 1.6rem;
        }
        .row {
          gap: 12px;
          padding: 6px;
        }
        h1 {
          font-size: 2rem;
        }
        #game-board {
          padding: 16px;
          max-width: 320px;
        }
        header {
          margin-top: 10px;
          margin-bottom: 10px;
          padding-bottom: 10px;
        }
      }

      @media (max-width: 600px) {
        /* ... existing styles ... */

        .tutorial-content {
          padding: 16px;
          max-width: 95%;
        }

        .mission-title {
          font-size: 1.4rem;
        }

        .mission-subtitle {
          font-size: 0.65rem;
        }

        .example-set {
          gap: 10px;
          padding: 12px 8px;
        }

        .example-tile {
          width: 45px;
          height: 45px;
          font-size: 1.3rem;
        }

        .example-caption {
          font-size: 0.65rem;
        }

        .rule-grid {
          gap: 10px;
        }

        .rule-line {
          font-size: 0.85rem;
        }

        .tutorial-btn {
          padding: 10px;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 5px;
        }
        .tile {
          width: 48px;
          height: 48px;
          font-size: 1.4rem;
        }
        .row {
          gap: 10px;
          padding: 6px;
        }
        #game-board {
          padding: 14px;
          max-width: 280px;
        }
        .key {
          height: 45px;
          font-size: 0.9rem;
        }
        .key-row {
          gap: 3px;
          margin-bottom: 5px;
        }
        h1 {
          font-size: 1.8rem;
        }
        .legend {
          font-size: 0.7rem;
          gap: 10px;
          padding: 6px 12px;
          margin-bottom: 10px;
        }
        header {
          margin-top: 8px;
          margin-bottom: 8px;
        }
      }

      @media (max-width: 480px) {
        /* ... existing styles ... */

        .tutorial-content {
          padding: 14px;
        }

        .mission-title {
          font-size: 1.3rem;
        }

        .example-tile {
          width: 40px;
          height: 40px;
          font-size: 1.2rem;
        }

        .rule-line {
          font-size: 0.8rem;
        }
      }

      @media (max-width: 380px) {
        body {
          padding: 3px;
        }
        .tile {
          width: 42px;
          height: 42px;
          font-size: 1.2rem;
        }
        .row {
          gap: 8px;
          padding: 5px;
        }
        #game-board {
          padding: 12px;
          max-width: 250px;
        }
        .key {
          height: 42px;
          font-size: 0.85rem;
        }
        .key::after {
          font-size: 0.6rem;
        }
        .key-row {
          gap: 2px;
          margin-bottom: 4px;
        }
        h1 {
          font-size: 1.6rem;
        }
        .legend {
          font-size: 0.65rem;
          gap: 8px;
          padding: 5px 10px;
        }
      }

      @media (max-width: 380px) {
        /* ... existing styles ... */

        .tutorial-content {
          padding: 12px;
        }

        .mission-title {
          font-size: 1.2rem;
        }

        .example-tile {
          width: 38px;
          height: 38px;
          font-size: 1.1rem;
        }

        .example-caption {
          font-size: 0.6rem;
        }

        .rule-line {
          font-size: 0.75rem;
        }
      }

      @media (max-width: 340px) {
        body {
          padding: 2px;
        }
        .tile {
          width: 38px;
          height: 38px;
          font-size: 1.1rem;
        }
        .row {
          gap: 6px;
          padding: 5px;
        }
        #game-board {
          padding: 10px;
          max-width: 220px;
        }
        .key {
          height: 40px;
          font-size: 0.8rem;
        }
        .key::after {
          font-size: 0.55rem;
        }
        h1 {
          font-size: 1.4rem;
        }
        .legend {
          font-size: 0.6rem;
          gap: 6px;
          padding: 4px 8px;
        }
      }

      /* Win Modal Responsive Styles */
      @media (max-width: 600px) {
        .stats-content {
          padding: 18px;
          max-height: none;
          overflow: visible;
        }

        .stash-display {
          padding: 10px;
          margin-bottom: 12px;
        }

        .stash-label {
          font-size: 0.75rem;
        }

        .stash-value {
          font-size: 1.8rem;
        }

        .stash-display > div {
          font-size: 0.8rem !important;
          gap: 5px !important;
        }

        .stats-grid {
          gap: 8px;
          margin: 12px 0;
        }

        .stat-value {
          font-size: 1.4rem;
        }

        .stat-label {
          font-size: 0.65rem;
        }

        .distribution-bars {
          gap: 5px;
        }

        .distribution-bar {
          height: 18px;
          font-size: 0.7rem;
        }

        .tutorial-btn,
        .close-stats {
          padding: 9px 14px;
          font-size: 0.9rem;
        }

        #win-modal h2 {
          font-size: 1.4rem;
          margin-bottom: 12px;
        }
      }

      @media (max-width: 480px) {
        .stats-content {
          padding: 14px;
          width: 95%;
        }

        .stash-display {
          padding: 8px;
          margin-bottom: 10px;
        }

        .stash-label {
          font-size: 0.7rem;
          margin-bottom: 3px;
        }

        .stash-value {
          font-size: 1.6rem;
        }

        .stash-display > div {
          font-size: 0.75rem !important;
          gap: 4px !important;
          margin: 10px 0 !important;
        }

        .stats-grid {
          gap: 6px;
          margin: 10px 0;
          padding-top: 10px;
        }

        .stat-value {
          font-size: 1.2rem;
        }

        .stat-label {
          font-size: 0.6rem;
        }

        .distribution-bars {
          gap: 4px;
        }

        .distribution-bar {
          height: 16px;
          font-size: 0.65rem;
        }

        .tutorial-btn,
        .close-stats {
          padding: 8px 12px;
          font-size: 0.85rem;
        }

        #win-modal h2 {
          font-size: 1.3rem;
          margin-bottom: 10px;
        }
      }

      @media (max-width: 380px) {
        .stats-content {
          padding: 12px;
        }

        .stash-display {
          padding: 6px;
          margin-bottom: 8px;
        }

        .stash-label {
          font-size: 0.65rem;
        }

        .stash-value {
          font-size: 1.4rem;
        }

        .stash-display > div {
          font-size: 0.7rem !important;
          gap: 3px !important;
          margin: 8px 0 !important;
        }

        .stats-grid {
          gap: 5px;
          margin: 8px 0;
          padding-top: 8px;
        }

        .stat-value {
          font-size: 1.1rem;
        }

        .stat-label {
          font-size: 0.55rem;
        }

        .distribution-bars {
          gap: 3px;
        }

        .distribution-bar {
          height: 14px;
          font-size: 0.6rem;
        }

        .tutorial-btn,
        .close-stats {
          padding: 7px 10px;
          font-size: 0.8rem;
        }

        #win-modal h2 {
          font-size: 1.2rem;
          margin-bottom: 8px;
        }
      }

      @media (max-width: 340px) {
        .stats-content {
          padding: 10px;
        }

        .stash-display {
          padding: 5px;
          margin-bottom: 6px;
        }

        .stash-label {
          font-size: 0.6rem;
        }

        .stash-value {
          font-size: 1.3rem;
        }

        .stash-display > div {
          font-size: 0.65rem !important;
          gap: 2px !important;
          margin: 6px 0 !important;
        }

        .stats-grid {
          gap: 4px;
          margin: 6px 0;
          padding-top: 6px;
        }

        .stat-value {
          font-size: 1rem;
        }

        .stat-label {
          font-size: 0.5rem;
        }

        .distribution-bars {
          gap: 2px;
        }

        .distribution-bar {
          height: 12px;
          font-size: 0.55rem;
        }

        .tutorial-btn,
        .close-stats {
          padding: 6px 8px;
          font-size: 0.75rem;
        }

        #win-modal h2 {
          font-size: 1.1rem;
          margin-bottom: 6px;
        }
      }

      /* Laptop/Desktop height constraints - NO SCROLLING */
      @media (max-height: 800px) {
        .stats-content {
          padding: 16px;
        }

        .stash-display {
          padding: 10px;
          margin-bottom: 10px;
        }

        .stash-label {
          font-size: 0.75rem;
        }

        .stash-value {
          font-size: 1.8rem;
        }

        .stash-display > div {
          font-size: 0.8rem !important;
          margin: 10px 0 !important;
        }

        .stats-grid {
          margin: 10px 0;
          gap: 8px;
        }

        #win-modal h2 {
          font-size: 1.5rem;
          margin-bottom: 10px;
        }

        .distribution-bars {
          gap: 4px;
        }

        .stat-value {
          font-size: 1.5rem;
        }
      }

      @media (max-height: 700px) {
        .stats-content {
          padding: 14px;
        }

        .stash-display {
          padding: 8px;
          margin-bottom: 8px;
        }

        .stash-label {
          font-size: 0.7rem;
        }

        .stash-value {
          font-size: 1.6rem;
        }

        .stash-display > div {
          font-size: 0.75rem !important;
          margin: 8px 0 !important;
          gap: 4px !important;
        }

        .stats-grid {
          margin: 8px 0;
          gap: 6px;
          padding-top: 8px;
        }

        .stat-value {
          font-size: 1.3rem;
        }

        .stat-label {
          font-size: 0.65rem;
        }

        #win-modal h2 {
          font-size: 1.3rem;
          margin-bottom: 8px;
        }

        .distribution-bars {
          gap: 3px;
        }

        .distribution-bar {
          height: 18px;
          font-size: 0.7rem;
        }

        .tutorial-btn,
        .close-stats {
          padding: 8px 14px;
          font-size: 0.9rem;
          margin-top: 12px;
        }
      }

      @media (max-height: 600px) {
        .stats-content {
          padding: 10px;
        }

        .stash-display {
          padding: 6px;
          margin-bottom: 6px;
        }

        .stash-label {
          font-size: 0.65rem;
        }

        .stash-value {
          font-size: 1.4rem;
        }

        .stash-display > div {
          font-size: 0.7rem !important;
          margin: 6px 0 !important;
          gap: 3px !important;
        }

        .stats-grid {
          margin: 6px 0;
          gap: 5px;
          padding-top: 6px;
        }

        .stat-value {
          font-size: 1.2rem;
        }

        .stat-label {
          font-size: 0.6rem;
        }

        #win-modal h2 {
          font-size: 1.2rem;
          margin-bottom: 6px;
        }

        .distribution-bars {
          gap: 2px;
        }

        .distribution-bar {
          height: 16px;
          font-size: 0.65rem;
        }

        .tutorial-btn,
        .close-stats {
          padding: 7px 12px;
          font-size: 0.85rem;
          margin-top: 8px;
        }
      }

      @media (max-height: 500px) {
        .stats-content {
          padding: 8px;
        }

        .stash-display {
          padding: 5px;
          margin-bottom: 5px;
        }

        .stash-label {
          font-size: 0.6rem;
        }

        .stash-value {
          font-size: 1.2rem;
        }

        .stash-display > div {
          font-size: 0.65rem !important;
          margin: 5px 0 !important;
          gap: 2px !important;
        }

        .stats-grid {
          margin: 5px 0;
          gap: 4px;
          padding-top: 5px;
        }

        .stat-value {
          font-size: 1rem;
        }

        .stat-label {
          font-size: 0.55rem;
        }

        #win-modal h2 {
          font-size: 1.1rem;
          margin-bottom: 5px;
        }

        .distribution-bars {
          gap: 2px;
        }

        .distribution-bar {
          height: 14px;
          font-size: 0.6rem;
        }

        .tutorial-btn,
        .close-stats {
          padding: 6px 10px;
          font-size: 0.8rem;
          margin-top: 6px;
        }
      }
      /* ==================== WIN ANIMATIONS ==================== */
      @keyframes confetti-fall {
        0% {
          transform: translateY(-100vh) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(720deg);
          opacity: 0;
        }
      }

      @keyframes cash-float {
        0% {
          transform: translateY(-20px) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(180deg);
          opacity: 0;
        }
      }

      @keyframes safe-open {
        0% {
          transform: perspective(1000px) rotateY(0deg);
        }
        100% {
          transform: perspective(1000px) rotateY(-90deg);
        }
      }

      @keyframes glow-pulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(106, 170, 100, 0.6),
            0 0 40px rgba(106, 170, 100, 0.4), 0 0 60px rgba(106, 170, 100, 0.2);
        }
        50% {
          box-shadow: 0 0 30px rgba(106, 170, 100, 0.8),
            0 0 60px rgba(106, 170, 100, 0.6), 0 0 90px rgba(106, 170, 100, 0.4);
        }
      }

      @keyframes screen-flash {
        0% {
          background: rgba(106, 170, 100, 0);
        }
        50% {
          background: rgba(106, 170, 100, 0.2);
        }
        100% {
          background: rgba(106, 170, 100, 0);
        }
      }

      .confetti-piece {
        position: fixed;
        width: 10px;
        height: 10px;
        top: -10px;
        z-index: 999;
        animation: confetti-fall 3s linear forwards;
        pointer-events: none;
      }

      .cash-bill {
        position: fixed;
        font-size: 2rem;
        top: -50px;
        z-index: 999;
        animation: cash-float 4s ease-in forwards;
        pointer-events: none;
      }

      .screen-flash {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 998;
        animation: screen-flash 0.5s ease-out;
      }

      .win-glow {
        animation: glow-pulse 1.5s ease-in-out infinite;
      }
    </style>
  </head>
  <body>
    <header>
      <button class="help-icon" onclick="showTutorial()">?</button>
      <button class="calendar-btn" onclick="showCalendar()">üìÖ</button>
      <h1>Tumbler</h1>
      <div class="sub-text">Crack the code</div>
      <!-- Timer moved to be part of the header flow -->
      <div class="timer-display">
        <svg
          class="timer-icon"
          width="14"
          height="14"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span id="timer">00:00</span>
      </div>

      <div
        id="streak-indicator"
        style="
          display: none;
          margin: 12px auto 0;
          max-width: 350px;
          width: 100%;
        "
      >
        <div
          style="
            background: var(--safe-inset);
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--safe-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              margin-bottom: 10px;
            "
          >
            <span style="font-size: 1.2rem">üî•</span>
            <div style="text-align: center">
              <div
                style="
                  font-size: 1.1rem;
                  font-weight: 700;
                  color: var(--text-color);
                  line-height: 1.2;
                "
                id="streak-current"
              >
                0 Day Streak
              </div>
              <div
                style="font-size: 0.7rem; color: #94a3b8; margin-top: 2px"
                id="streak-subtitle"
              >
                Keep it going!
              </div>
            </div>
          </div>

          <div
            style="
              background: var(--safe-body);
              border-radius: 10px;
              height: 8px;
              overflow: hidden;
              border: 1px solid rgba(255, 255, 255, 0.05);
              position: relative;
            "
          >
            <div
              id="streak-progress-bar"
              style="
                height: 100%;
                background: linear-gradient(
                  90deg,
                  var(--color-close),
                  var(--color-correct)
                );
                width: 0%;
                transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 0 10px rgba(106, 170, 100, 0.5);
              "
            ></div>
          </div>

          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-top: 6px;
              font-size: 0.65rem;
              color: #64748b;
            "
          >
            <span id="streak-start">0</span>
            <span
              id="streak-milestone"
              style="color: var(--color-correct); font-weight: 700"
              >25</span
            >
          </div>
        </div>
      </div>

      <button class="stats-btn" onclick="showStats()">üìä Stats</button>
      <button
        class="mute-btn stats-btn"
        onclick="toggleMute()"
        style="right: 90px"
      >
        üîä
      </button>
    </header>

    <button
      class="stats-btn"
      onclick="openGroupModal()"
      style="position: static; margin-bottom: 15px; margin-top: 10px"
    >
      üë• Crew
    </button>

    <script>
      // Check for crew invite in URL on page load
      (function checkCrewInvite() {
        const urlParams = new URLSearchParams(window.location.search);
        const crewParam = urlParams.get("crew");

        if (crewParam) {
          const crewId = crewParam.toUpperCase();
          sessionStorage.setItem("inviteCrew", crewId);

          setTimeout(() => {
            openGroupModal();
          }, 500);
        }
      })();
    </script>

    <div id="tutorial-modal" class="tutorial-modal">
      <div class="tutorial-content">
        <div class="mission-header">
          <h2 class="mission-title">Mission Briefing</h2>
          <div class="mission-subtitle">Crack the 4-Letter Code</div>
        </div>

        <div class="example-set">
          <div class="example-item">
            <div class="example-tile correct">C</div>
            <div class="example-caption">
              <strong style="color: var(--color-correct)">LOCKED</strong
              ><br />Correct Letter
            </div>
          </div>

          <div class="example-item">
            <div class="example-tile close">
              J
              <div class="example-arrow">‚ñ≤</div>
            </div>
            <div class="example-caption">
              <strong style="color: var(--color-close)">CLOSE</strong
              ><br />Within 9
            </div>
          </div>

          <div class="example-item">
            <div class="example-tile far">
              Z
              <div class="example-arrow">‚ñº‚ñº</div>
            </div>
            <div class="example-caption">
              <strong style="color: var(--color-far)">FAR</strong><br />10+ Away
            </div>
          </div>
        </div>

        <div class="rule-grid">
          <div class="rule-line">
            <div class="icon-box">üéØ</div>
            <div>Guess the secret word in <strong>6 attempts</strong>.</div>
          </div>

          <div class="rule-line">
            <div class="icon-box">‚ÜïÔ∏è</div>
            <div>
              <strong>Follow the Arrows:</strong> They point towards the
              answer.<br />
              <span style="font-size: 0.8rem; color: #94a3b8">
                (e.g. <strong>‚ñ≤</strong> means the real letter is
                <em>Higher</em> in the alphabet)
              </span>
            </div>
          </div>

          <div class="rule-line">
            <div class="icon-box">‚å®Ô∏è</div>
            <div>
              <strong>Intel Assist:</strong> Impossible keys are automatically
              disabled to help you.
            </div>
          </div>

          <div class="rule-line">
            <div class="icon-box">üîç</div>
            <div>
              <strong>Intel Boost:</strong> Stuck? Purchase vault intel to see
              the code sum for <strong>$1,500</strong>.
            </div>
          </div>
        </div>

        <div class="rule-line">
          <div class="icon-box">üë•</div>
          <div>
            <strong>Join a Crew:</strong> Compete with friends on daily and
            career leaderboards.<br />
            <span style="font-size: 0.8rem; color: #94a3b8">
              (Click <strong>üë• Crew</strong> button to create or join a group)
            </span>
          </div>
        </div>

        <button class="tutorial-btn" onclick="closeTutorial()">
          START CRACKING
        </button>
      </div>
    </div>

    <div id="ready-modal" class="tutorial-modal">
      <div class="tutorial-content" style="max-width: 380px">
        <div class="mission-header">
          <h2 class="mission-title" id="ready-puzzle-title">
            Ready for Today's Heist?
          </h2>
          <div class="mission-subtitle" id="ready-puzzle-number">
            TUMBLER #1
          </div>
        </div>

        <div
          style="
            background: var(--safe-inset);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid var(--safe-border);
            text-align: center;
          "
        >
          <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px">
            üéØ YOUR STATS
          </div>
          <div
            style="
              display: flex;
              justify-content: space-around;
              margin-top: 15px;
            "
          >
            <div>
              <div
                style="
                  font-size: 1.5rem;
                  font-weight: 700;
                  color: var(--color-correct);
                "
                id="ready-streak"
              >
                0
              </div>
              <div style="font-size: 0.7rem; color: #94a3b8">Streak üî•</div>
            </div>
            <div>
              <div
                style="
                  font-size: 1.5rem;
                  font-weight: 700;
                  color: var(--color-cash);
                "
                id="ready-cash"
              >
                $0
              </div>
              <div style="font-size: 0.7rem; color: #94a3b8">Total Stash</div>
            </div>
          </div>
        </div>

        <div
          style="
            font-size: 0.85rem;
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: center;
          "
        >
          Timer starts when you begin. Good luck! üçÄ
        </div>

        <button class="tutorial-btn" onclick="startCracking()">
          START CRACKING
        </button>
      </div>
    </div>

    <div id="stats-modal" class="stats-modal">
      <div class="stats-content">
        <h2 style="margin-top: 0; text-align: center">Your Stash & Stats</h2>

        <div class="stash-display">
          <div class="stash-label">Total Stash Value</div>
          <div class="stash-value" id="stat-total-cash">$0</div>
        </div>

        <div
          style="
            background: var(--safe-inset);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--safe-border);
          "
        >
          <div
            style="
              font-size: 0.85rem;
              color: #94a3b8;
              margin-bottom: 8px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span>üõ°Ô∏è Streak Protectors</span>
            <span
              style="color: var(--color-correct); font-weight: 700"
              id="protector-count"
              >0</span
            >
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 8px;
              font-size: 0.75rem;
            "
          >
            <button
              id="protector-btn"
              onclick="buyProtector()"
              class="group-action-btn secondary"
              style="margin: 0; padding: 8px; font-size: 0.75rem"
            >
              Buy Insurance<br /><span style="opacity: 0.8">$50,000</span>
            </button>
            <button
              onclick="buyRecovery()"
              class="group-action-btn secondary"
              style="margin: 0; padding: 8px; font-size: 0.75rem; opacity: 0.5"
              id="recovery-btn"
              disabled
            >
              Buy Recovery<br /><span style="opacity: 0.8">$75,000</span>
            </button>
          </div>
          <div
            style="
              font-size: 0.65rem;
              color: #64748b;
              margin-top: 6px;
              line-height: 1.3;
            "
          >
            Insurance: Protects next missed day (max 3, once/month)<br />
            Recovery: Available only after missing a day
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="stat-played">0</div>
            <div class="stat-label">Played</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-winrate">0</div>
            <div class="stat-label">Win %</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-streak">0</div>
            <div class="stat-label">Streak üî•</div>
          </div>
        </div>
        <button class="close-stats" onclick="closeStats()">Close</button>
      </div>
    </div>

    <div id="win-modal" class="tutorial-modal">
      <div class="tutorial-content">
        <h2>üéâ VAULT BREACHED!</h2>

        <div class="stash-display">
          <div class="stash-label">Heist Breakdown</div>

          <div
            style="
              display: flex;
              flex-direction: column;
              gap: 8px;
              margin: 15px 0;
              font-size: 0.9rem;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                color: #cbd5e1;
              "
            >
              <span>üí∞ Base Vault:</span>
              <span style="font-weight: 700">$10,000</span>
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                color: #ef4444;
              "
            >
              <span>üö® Attempts Cost:</span>
              <span style="font-weight: 700" id="win-penalties">-$0</span>
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                color: var(--color-correct);
              "
            >
              <span>‚ö° Speed Bonus:</span>
              <span style="font-weight: 700" id="win-speed-bonus">+$0</span>
            </div>

            <div
              id="intel-cost-row"
              style="
                display: none;
                justify-content: space-between;
                color: var(--color-close);
              "
            >
              <span>üîç Intel Cost:</span>
              <span style="font-weight: 700">-$1,500</span>
            </div>

            <div
              style="height: 1px; background: var(--safe-border); margin: 5px 0"
            ></div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                font-size: 1.1rem;
                color: var(--color-cash);
              "
            >
              <span style="font-weight: 700">üíº Final Take:</span>
              <span style="font-weight: 700" id="win-cash-earned">$0</span>
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="win-attempts">0</div>
            <div class="stat-label">Attempts</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="win-time">0s</div>
            <div class="stat-label">Time</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="win-total-cash">$0</div>
            <div class="stat-label">Total Stash</div>
          </div>
        </div>

        <div style="margin: 20px 0; text-align: center">
          <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px">
            GUESS DISTRIBUTION
          </div>
          <div id="distribution-bars"></div>
        </div>

        <button
          class="tutorial-btn"
          id="share-result-btn"
          onclick="shareResult()"
        >
          üì§ Share Result
        </button>
        <button class="close-stats" onclick="closeWinModal()">Close</button>
      </div>
    </div>

    <div
      class="intel-tool"
      style="
        width: 100%;
        max-width: 350px;
        margin-bottom: 15px;
        display: flex;
        justify-content: center;
      "
    >
      <button class="intel-btn" id="intel-btn" onclick="confirmIntel()">
        üîç VIEW INTEL
        <span
          style="
            display: block;
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 3px;
          "
        >
          Costs $1,500
        </span>
      </button>
    </div>

    <!-- Intel Panel (hidden by default) -->
    <div
      id="intel-panel"
      class="countdown-display"
      style="display: none; margin-bottom: 15px"
    >
      <div class="countdown-label">üéØ VAULT INTEL</div>
      <div
        style="
          font-size: 1.5rem;
          font-weight: 700;
          color: var(--color-correct);
          margin: 10px 0;
        "
      >
        Code Sum: <span id="code-sum-value">0</span>
      </div>
      <div
        style="
          margin-top: 15px;
          padding-top: 15px;
          border-top: 1px solid var(--safe-border);
        "
      >
        <div class="countdown-label" style="margin-bottom: 5px">
          Your Current Sum
        </div>
        <div
          style="font-size: 1.8rem; font-weight: 700; color: var(--color-close)"
          id="current-sum-value"
        >
          0
        </div>
      </div>

      <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 10px">
        A=1, B=2, C=3 ... Z=26
      </div>
    </div>

    <div id="calendar-modal" class="stats-modal">
      <div class="stats-content" style="max-width: 500px">
        <h2 style="margin-top: 0">Heist Archive</h2>
        <div style="margin-bottom: 15px; font-size: 0.9rem; color: #94a3b8">
          Replay past jobs.
          <span style="color: var(--color-far)">Past jobs pay 10% value.</span>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
        <button class="close-stats" onclick="closeCalendar()">Close</button>
      </div>
    </div>

    <div id="message-container"></div>

    <div id="game-board"></div>

    <div class="legend">
      <div class="legend-item">
        <div class="dot" style="background: var(--color-far)"></div>
        Far (10+)
      </div>
      <div class="legend-item">
        <div class="dot" style="background: var(--color-close)"></div>
        Close (1-9)
      </div>
      <div class="legend-item">
        <div class="dot" style="background: var(--color-correct)"></div>
        Locked In
      </div>
    </div>

    <div class="keyboard-toggle">
      <button class="keyboard-toggle-btn" onclick="toggleKeyboardLayout()">
        ‚å®Ô∏è <span id="keyboard-layout-text">ABC</span>
      </button>
    </div>

    <div id="keyboard"></div>

    <div id="group-modal" class="group-modal">
      <div class="group-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 style="margin: 0">Heist Crew</h2>
          <button
            class="help-icon"
            onclick="closeGroupModal()"
            style="position: static"
          >
            ‚úï
          </button>
        </div>

        <!-- ADD THIS NEW SECTION: User Info Card (only shown when logged in) -->
        <div
          id="user-info-card"
          style="
            display: none;
            background: var(--safe-inset);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--safe-border);
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div>
              <div
                style="
                  font-size: 0.75rem;
                  color: #94a3b8;
                  text-transform: uppercase;
                  letter-spacing: 1px;
                  margin-bottom: 4px;
                "
              >
                Your Codename
              </div>
              <div
                style="
                  font-size: 1.3rem;
                  font-weight: 700;
                  color: var(--color-correct);
                "
                id="user-name-display"
              >
                ---
              </div>
            </div>
            <button
              onclick="showNameEdit()"
              style="
                background: var(--key-bg);
                color: var(--text-color);
                border: none;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: 700;
              "
            >
              ‚úèÔ∏è Edit
            </button>
          </div>
        </div>

        <!-- Badge Showcase -->
        <div id="badge-showcase" style="display: none">
          <div class="badge-showcase">
            <div class="showcase-label">üèÜ Your Weekly Crew Badges</div>
            <div
              style="
                font-size: 0.7rem;
                color: #94a3b8;
                text-align: center;
                margin-bottom: 10px;
              "
            >
              Compete for new badges each week!
            </div>
            <div class="user-badges" id="user-badges-display">
              <div style="color: #64748b; font-size: 0.85rem">
                No badges yet. Start playing!
              </div>
            </div>
            <div class="weekly-reset-timer" id="weekly-reset-timer"></div>
          </div>
        </div>

        <!-- Name Edit Panel (hidden by default) -->
        <div
          id="name-edit-panel"
          style="
            display: none;
            background: var(--safe-inset);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--color-close);
          "
        >
          <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px">
            Change Codename
          </div>
          <input
            type="text"
            id="name-edit-input"
            class="group-input"
            placeholder="Enter new name (2-10 chars)"
            maxlength="10"
            style="margin-bottom: 10px"
          />
          <div style="display: flex; gap: 8px">
            <button
              class="group-action-btn"
              onclick="saveNewName()"
              style="margin-top: 0; flex: 1"
            >
              ‚úì Save
            </button>
            <button
              class="group-action-btn secondary"
              onclick="cancelNameEdit()"
              style="margin-top: 0; flex: 1"
            >
              Cancel
            </button>
          </div>
          <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 8px">
            Updates across all crews
          </div>
        </div>

        <!-- Crew Selector (only shown when multiple crews) -->
        <div id="crew-selector" style="display: none; margin-bottom: 15px">
          <div
            style="
              font-size: 0.8rem;
              color: #94a3b8;
              margin-bottom: 8px;
              text-transform: uppercase;
              letter-spacing: 1px;
            "
          >
            Select Crew to View
          </div>
          <select
            id="crew-dropdown"
            class="group-input"
            onchange="switchCrew()"
            style="margin-bottom: 0; cursor: pointer; font-weight: 700"
          ></select>
        </div>

        <div id="view-setup">
          <p style="color: #94a3b8; font-size: 0.9rem">
            Enter a codename and a Crew ID to compete.
          </p>
          <input
            type="text"
            id="player-nick"
            class="group-input"
            placeholder="Your Codename (e.g., Fox)"
            maxlength="10"
          />
          <input
            type="text"
            id="group-id"
            class="group-input"
            placeholder="Crew ID (e.g., OfficeHeist)"
            maxlength="15"
          />
          <button class="group-action-btn" onclick="joinGroup()">
            Join / Create Crew
          </button>
        </div>

        <div id="view-leaderboard" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 10px;
              color: #94a3b8;
              font-size: 0.8rem;
            "
          >
            <span id="display-group-name">Crew: --</span>
            <span
              style="cursor: pointer; text-decoration: underline"
              onclick="logoutGroup()"
              >Leave</span
            >
          </div>

          <!-- Add Join New Crew Button -->
          <button
            class="group-action-btn secondary"
            onclick="showJoinNewCrew()"
            style="margin-bottom: 15px"
          >
            + Join Another Crew
          </button>

          <!-- Add Share Crew Button -->
          <button
            class="group-action-btn secondary"
            onclick="shareCrewInvite()"
            style="margin-bottom: 15px; background: var(--color-close)"
          >
            üì§ Share Crew Invite
          </button>

          <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('daily')">
              Today's Take
            </button>
            <button class="tab-btn" onclick="switchTab('overall')">
              Career Stash
            </button>
          </div>

          <div id="lb-list" style="min-height: 200px">
            <div style="text-align: center; padding: 20px; color: #64748b">
              Loading data...
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="protector-confirm-modal"
      class="tutorial-modal"
      style="display: none"
    >
      <div class="tutorial-content" style="max-width: 380px">
        <h2 style="margin-top: 0; font-size: 1.5rem">üõ°Ô∏è Streak Insurance</h2>

        <div
          style="
            background: var(--safe-inset);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid var(--safe-border);
          "
        >
          <div
            style="
              font-size: 0.9rem;
              color: #94a3b8;
              margin-bottom: 12px;
              line-height: 1.5;
            "
          >
            Protect your streak from being lost if you miss a day.
          </div>
          <div
            style="
              font-size: 1.8rem;
              font-weight: 700;
              color: var(--color-far);
              margin-bottom: 15px;
            "
          >
            Cost: $50,000
          </div>
          <div
            style="
              background: var(--safe-body);
              padding: 12px;
              border-radius: 8px;
              font-size: 0.85rem;
              color: #cbd5e1;
              line-height: 1.6;
            "
          >
            <div style="margin-bottom: 8px">
              <strong style="color: var(--color-correct)"
                >‚úì How it works:</strong
              >
            </div>
            <div style="margin-left: 10px; margin-bottom: 6px">
              ‚Ä¢ Automatically activates if you miss a day
            </div>
            <div style="margin-left: 10px; margin-bottom: 6px">
              ‚Ä¢ Protects your streak once
            </div>
            <div style="margin-left: 10px; margin-bottom: 6px">
              ‚Ä¢ Can hold up to 3 protectors
            </div>
            <div style="margin-left: 10px">‚Ä¢ Limit: 1 purchase per month</div>
          </div>
        </div>

        <div style="display: flex; gap: 10px">
          <button
            class="tutorial-btn"
            onclick="confirmProtectorPurchase()"
            style="flex: 1"
          >
            ‚úì Purchase
          </button>
          <button
            class="close-stats"
            onclick="closeProtectorModal()"
            style="flex: 1; margin-top: 0"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <div
      id="recovery-confirm-modal"
      class="tutorial-modal"
      style="display: none"
    >
      <div class="tutorial-content" style="max-width: 380px">
        <h2 style="margin-top: 0; font-size: 1.5rem">üîÑ Streak Recovery</h2>

        <div
          style="
            background: var(--safe-inset);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid var(--safe-border);
          "
        >
          <div
            style="
              font-size: 0.9rem;
              color: #94a3b8;
              margin-bottom: 12px;
              line-height: 1.5;
            "
          >
            Restore your broken streak after missing a day.
          </div>
          <div
            style="
              font-size: 1.8rem;
              font-weight: 700;
              color: var(--color-far);
              margin-bottom: 15px;
            "
          >
            Cost: $75,000
          </div>
          <div
            style="
              background: var(--safe-body);
              padding: 12px;
              border-radius: 8px;
              font-size: 0.85rem;
              color: #cbd5e1;
              line-height: 1.6;
            "
          >
            <div style="margin-bottom: 8px">
              <strong style="color: var(--color-correct)"
                >‚úì How it works:</strong
              >
            </div>
            <div style="margin-left: 10px; margin-bottom: 6px">
              ‚Ä¢ Only available after missing a day
            </div>
            <div style="margin-left: 10px; margin-bottom: 6px">
              ‚Ä¢ Must be used immediately (next day)
            </div>
            <div style="margin-left: 10px; margin-bottom: 6px">
              ‚Ä¢ Restores your streak to 1 day
            </div>
            <div style="margin-left: 10px">‚Ä¢ One-time emergency recovery</div>
          </div>
        </div>

        <div style="display: flex; gap: 10px">
          <button
            class="tutorial-btn"
            onclick="confirmRecoveryPurchase()"
            style="flex: 1"
          >
            ‚úì Recover Streak
          </button>
          <button
            class="close-stats"
            onclick="closeRecoveryModal()"
            style="flex: 1; margin-top: 0"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- CONFIGURATION ---
      let currentPlayDate = new Date();
      const WORD_LENGTH = 4;
      const MAX_TRIES = 6;
      const ASCII_A = 65;
      const ASCII_Z = 90;
      const CLOSE_DISTANCE = 9;
      const FAR_DISTANCE = 10;
      const GAME_EPOCH = new Date("November 26, 2025 00:00:00");

      // CASH CALCULATION CONSTANTS
      const CASH_BASE_VALUE = 10000;
      const CASH_ATTEMPT_PENALTY = 1000;
      const CASH_SPEED_BONUS_CAP = 60; // seconds
      const CASH_PER_SECOND_BONUS = 20;
      const CASH_MINIMUM_PAYOUT = 500;
      const INTEL_COST = 1500;
      // STREAK REWARDS
      const STREAK_MILESTONE = 25;
      const STREAK_BONUS_PER_MILESTONE = 1000;
      const STREAK_PROTECTOR_COST = 50000;
      const STREAK_RECOVERY_COST = 75000;

      // ==================== SOUND EFFECTS ====================
      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();
      let isMuted = localStorage.getItem("tumblerMuted") === "true";

      function playSound(type) {
        if (isMuted) return;

        const now = audioContext.currentTime;
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        switch (type) {
          case "keypress":
            oscillator.frequency.setValueAtTime(400, now);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            oscillator.start(now);
            oscillator.stop(now + 0.1);
            break;

          case "correct":
            oscillator.frequency.setValueAtTime(523.25, now); // C5
            oscillator.frequency.setValueAtTime(659.25, now + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, now + 0.2); // G5
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            oscillator.start(now);
            oscillator.stop(now + 0.3);
            break;

          case "close":
            oscillator.frequency.setValueAtTime(440, now);
            gainNode.gain.setValueAtTime(0.15, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            oscillator.start(now);
            oscillator.stop(now + 0.15);
            break;

          case "far":
            oscillator.frequency.setValueAtTime(200, now);
            gainNode.gain.setValueAtTime(0.15, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            oscillator.start(now);
            oscillator.stop(now + 0.2);
            break;

          case "error":
            oscillator.frequency.setValueAtTime(150, now);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            oscillator.start(now);
            oscillator.stop(now + 0.3);
            break;

          case "win":
            // Ascending victory fanfare
            const notes = [523.25, 659.25, 783.99, 1046.5]; // C5, E5, G5, C6
            notes.forEach((freq, i) => {
              const osc = audioContext.createOscillator();
              const gain = audioContext.createGain();
              osc.connect(gain);
              gain.connect(audioContext.destination);
              osc.frequency.setValueAtTime(freq, now + i * 0.15);
              gain.gain.setValueAtTime(0.3, now + i * 0.15);
              gain.gain.exponentialRampToValueAtTime(
                0.01,
                now + i * 0.15 + 0.4
              );
              osc.start(now + i * 0.15);
              osc.stop(now + i * 0.15 + 0.4);
            });
            break;
        }
      }

      function wasYesterdayPlayed() {
        const yesterday = new Date(currentPlayDate);
        yesterday.setDate(yesterday.getDate() - 1);
        yesterday.setHours(0, 0, 0, 0);

        const yesterdayKey = getStorageKey(yesterday);
        const saved = localStorage.getItem(yesterdayKey);

        if (!saved) return false;

        const gameData = JSON.parse(saved);
        // Check if they WON yesterday (not just played)
        return gameData.cashWon > 0;
      }

      function toggleMute() {
        isMuted = !isMuted;
        localStorage.setItem("tumblerMuted", isMuted);
        const btn = document.querySelector(".mute-btn");
        btn.textContent = isMuted ? "üîá" : "üîä";
        playSound("keypress"); // Test sound
      }

      function checkStreakMilestone() {
        const currentStreak = stats.currentStreak;
        const nextMilestone =
          Math.ceil(currentStreak / STREAK_MILESTONE) * STREAK_MILESTONE;
        const progress = currentStreak % STREAK_MILESTONE || STREAK_MILESTONE;
        const daysUntil = nextMilestone - currentStreak;

        return {
          currentStreak,
          nextMilestone,
          progress,
          daysUntil,
          isAtMilestone:
            currentStreak > 0 && currentStreak % STREAK_MILESTONE === 0,
          shouldShowIndicator: currentStreak > 0,
        };
      }

      function awardStreakBonus() {
        const { currentStreak, isAtMilestone } = checkStreakMilestone();

        if (isAtMilestone && stats.lastStreakMilestone < currentStreak) {
          const bonus = currentStreak * STREAK_BONUS_PER_MILESTONE;
          stats.totalCash += bonus;
          stats.lastStreakMilestone = currentStreak;
          localStorage.setItem("tumblerStats", JSON.stringify(stats));

          return bonus;
        }
        return 0;
      }

      function updateStreakIndicator() {
        const indicator = document.getElementById("streak-indicator");
        const currentEl = document.getElementById("streak-current");
        const subtitleEl = document.getElementById("streak-subtitle");
        const bar = document.getElementById("streak-progress-bar");
        const startEl = document.getElementById("streak-start");
        const milestoneEl = document.getElementById("streak-milestone");

        if (!indicator || !currentEl || !bar) return;

        const {
          shouldShowIndicator,
          daysUntil,
          progress,
          nextMilestone,
          currentStreak,
        } = checkStreakMilestone();

        if (shouldShowIndicator) {
          indicator.style.display = "block";

          // Update main text
          currentEl.textContent = `${currentStreak} Day Streak`;

          // Update subtitle
          // Update subtitle
          if (daysUntil === 0) {
            const milestoneBonus = currentStreak * STREAK_BONUS_PER_MILESTONE;
            subtitleEl.innerHTML = `üéâ <strong style="color: var(--color-correct);">Milestone reached!</strong> +$${milestoneBonus.toLocaleString()}`;
          } else {
            const nextBonus = nextMilestone * STREAK_BONUS_PER_MILESTONE;
            subtitleEl.textContent = `${daysUntil} day${
              daysUntil > 1 ? "s" : ""
            } to $${nextBonus.toLocaleString()} bonus`;
          }

          // Update progress bar
          const progressPercent = (progress / STREAK_MILESTONE) * 100;
          bar.style.width = `${progressPercent}%`;

          // Update milestone markers
          const startOfProgress =
            Math.floor(currentStreak / STREAK_MILESTONE) * STREAK_MILESTONE;
          startEl.textContent = startOfProgress;
          milestoneEl.textContent = nextMilestone;
        } else {
          indicator.style.display = "none";
        }
      }

      function buyProtector() {
        // Check if user has enough cash first
        if (stats.totalCash < STREAK_PROTECTOR_COST) {
          showMessage("‚ùå Not enough cash!");
          playSound("error");
          return;
        }

        // Check if already at max protectors
        if (stats.streakProtectors >= 3) {
          showMessage("‚ùå Max 3 protectors!");
          playSound("error");
          return;
        }

        // Check monthly limit
        const now = Date.now();
        const oneMonth = 30 * 24 * 60 * 60 * 1000;
        const timeSinceLastPurchase = now - (stats.lastProtectorPurchase || 0);

        if (timeSinceLastPurchase < oneMonth) {
          const daysRemaining = Math.ceil(
            (oneMonth - timeSinceLastPurchase) / (24 * 60 * 60 * 1000)
          );
          showMessage(`‚ùå Available in ${daysRemaining} days!`);
          playSound("error");
          return;
        }

        // Show confirmation modal
        document.getElementById("protector-confirm-modal").style.display =
          "flex";
      }

      function confirmProtectorPurchase() {
        stats.totalCash -= STREAK_PROTECTOR_COST;
        stats.streakProtectors++;
        stats.lastProtectorPurchase = Date.now();
        localStorage.setItem("tumblerStats", JSON.stringify(stats));

        closeProtectorModal();
        showMessage("‚úÖ Protector purchased!");
        playSound("correct");
        showStats(); // Refresh the stats modal
      }

      function closeProtectorModal() {
        document.getElementById("protector-confirm-modal").style.display =
          "none";
      }

      function confirmRecoveryPurchase() {
        stats.totalCash -= STREAK_RECOVERY_COST;
        stats.currentStreak = 1;
        localStorage.setItem("tumblerStats", JSON.stringify(stats));

        closeRecoveryModal();
        showMessage("‚úÖ Streak recovered to 1 day!");
        playSound("correct");
        showStats(); // Refresh the stats modal
        updateStreakIndicator();
      }

      function closeRecoveryModal() {
        document.getElementById("recovery-confirm-modal").style.display =
          "none";
      }

      function buyRecovery() {
        if (stats.currentStreak > 0) {
          showMessage("‚ùå Only available after missing a day!");
          playSound("error");
          return;
        }

        if (stats.totalCash < STREAK_RECOVERY_COST) {
          showMessage("‚ùå Not enough cash!");
          playSound("error");
          return;
        }

        if (!wasYesterdayPlayed()) {
          showMessage("‚ùå Can only recover immediately after missing!");
          playSound("error");
          return;
        }

        document.getElementById("recovery-confirm-modal").style.display =
          "flex";

        stats.totalCash -= STREAK_RECOVERY_COST;
        stats.currentStreak = 1;
        localStorage.setItem("tumblerStats", JSON.stringify(stats));

        showMessage("‚úÖ Streak recovered to 1 day!");
        playSound("correct");
        showStats();
        updateStreakIndicator();
      }

      window.buyProtector = buyProtector;
      window.buyRecovery = buyRecovery;

      // --- STATE VARIABLES ---
      let TARGET_WORD = "";
      let currentRow = 0;
      let currentTile = 0;
      let guesses = Array(6)
        .fill(null)
        .map(() => Array(4).fill(""));
      let isGameOver = false;
      let startTime = null;
      let timerInterval = null;
      let intelUsed = false;

      let dictionary = new Set();
      let answerList = [];
      let slotConstraints = [];
      let keyboardLayout =
        localStorage.getItem("tumblerKeyboardLayout") || "abc"; // 'abc' or 'qwerty'

      const board = document.getElementById("game-board");
      const keyboardContainer = document.getElementById("keyboard");
      const messageContainer = document.getElementById("message-container");

      // Load stats from localStorage, including NEW: totalCash
      let stats = JSON.parse(
        localStorage.getItem("tumblerStats") ||
          '{"played":0,"won":0,"archiveWon":0,"currentStreak":0,"maxStreak":0,"guessDistribution":[0,0,0,0,0,0], "totalCash": 0, "streakProtectors": 0, "lastStreakMilestone": 0, "lastProtectorPurchase": 0}'
      );

      // Ensure new properties exist
      if (typeof stats.streakProtectors !== "number") {
        stats.streakProtectors = 0;
      }
      if (typeof stats.lastStreakMilestone !== "number") {
        stats.lastStreakMilestone = 0;
      }
      if (typeof stats.lastProtectorPurchase !== "number") {
        stats.lastProtectorPurchase = 0;
      }

      if (typeof stats.archiveWon !== "number") {
        stats.archiveWon = 0;
      }

      // Ensure totalCash exists (for users upgrading from old version)
      if (typeof stats.totalCash !== "number") {
        stats.totalCash = 0;
      }

      // ==================== WIN ANIMATIONS ====================
      function createConfetti() {
        const colors = ["#6aaa64", "#c9b458", "#00ff6a", "#f8fafc", "#fbbf24"];
        const confettiCount = 50;

        for (let i = 0; i < confettiCount; i++) {
          setTimeout(() => {
            const confetti = document.createElement("div");
            confetti.classList.add("confetti-piece");
            confetti.style.left = Math.random() * 100 + "%";
            confetti.style.backgroundColor =
              colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 0.5 + "s";
            confetti.style.animationDuration = Math.random() * 2 + 2 + "s";
            document.body.appendChild(confetti);

            setTimeout(() => confetti.remove(), 5000);
          }, i * 30);
        }
      }

      function createCashRain() {
        const cashSymbols = ["üíµ", "üí∞", "üí∏", "üí¥", "üí∂"];
        const cashCount = 20;

        for (let i = 0; i < cashCount; i++) {
          setTimeout(() => {
            const cash = document.createElement("div");
            cash.classList.add("cash-bill");
            cash.textContent =
              cashSymbols[Math.floor(Math.random() * cashSymbols.length)];
            cash.style.left = Math.random() * 100 + "%";
            cash.style.animationDelay = Math.random() * 0.3 + "s";
            cash.style.animationDuration = Math.random() * 2 + 3 + "s";
            document.body.appendChild(cash);

            setTimeout(() => cash.remove(), 7000);
          }, i * 100);
        }
      }

      function createScreenFlash() {
        const flash = document.createElement("div");
        flash.classList.add("screen-flash");
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 500);
      }

      function animateCountUp(elementId, targetValue, duration = 2000) {
        const element = document.getElementById(elementId);
        const startValue = 0;
        const startTime = Date.now();

        const formatter = new Intl.NumberFormat("en-US");

        function update() {
          const now = Date.now();
          const elapsed = now - startTime;
          const progress = Math.min(elapsed / duration, 1);

          // Easing function for smooth deceleration
          const easeOutQuart = 1 - Math.pow(1 - progress, 4);
          const currentValue = Math.floor(
            startValue + (targetValue - startValue) * easeOutQuart
          );

          element.textContent = `$${formatter.format(currentValue)}`;

          if (progress < 1) {
            requestAnimationFrame(update);
          } else {
            element.textContent = `$${formatter.format(targetValue)}`;
          }
        }

        update();
      }

      function showNameEdit() {
        document.getElementById("user-info-card").style.display = "none";
        document.getElementById("name-edit-panel").style.display = "block";
        document.getElementById("name-edit-input").value = userNick;
        document.getElementById("name-edit-input").focus();
      }

      function cancelNameEdit() {
        document.getElementById("name-edit-panel").style.display = "none";
        document.getElementById("user-info-card").style.display = "block";
      }

      async function saveNewName() {
        const newName = document
          .getElementById("name-edit-input")
          .value.trim()
          .toUpperCase();

        if (newName.length < 2) {
          showMessage("Name must be at least 2 characters!");
          return;
        }

        if (newName === userNick) {
          cancelNameEdit();
          return;
        }

        const oldName = userNick;
        userNick = newName;
        localStorage.setItem("tumblerNick", newName);

        // Update display immediately
        document.getElementById("user-name-display").textContent = newName;

        // Update Firebase for all crews
        if (db && userGroups.length > 0) {
          const today = new Date();
          const dateKey = `${today.getFullYear()}-${
            today.getMonth() + 1
          }-${today.getDate()}`;

          for (const group of userGroups) {
            // 1. Copy today's score to new name (if exists)
            if (oldName) {
              try {
                const oldScoreRef = db.ref(
                  `scores/${group}/${dateKey}/${oldName}`
                );
                const snapshot = await oldScoreRef.once("value");
                if (snapshot.exists()) {
                  await db
                    .ref(`scores/${group}/${dateKey}/${newName}`)
                    .set(snapshot.val());
                  await oldScoreRef.remove();
                }

                // 2. Copy career stats to new name
                const oldCareerRef = db.ref(`career/${group}/${oldName}`);
                const careerSnapshot = await oldCareerRef.once("value");
                if (careerSnapshot.exists()) {
                  await db
                    .ref(`career/${group}/${newName}`)
                    .set(careerSnapshot.val());
                  await oldCareerRef.remove();
                }
              } catch (e) {
                console.log("Offline mode: Name change saved locally");
              }
            }

            // 3. Update member list
            try {
              await db.ref(`groups/${group}/members/${newName}`).update({
                joined: Date.now(),
                lastActive: Date.now(),
              });

              if (oldName) {
                await db.ref(`groups/${group}/members/${oldName}`).remove();
              }
            } catch (e) {
              console.log("Offline mode: Name change saved locally");
            }
          }
        }

        showMessage(`‚úÖ Name changed to ${newName}!`);
        cancelNameEdit();
        loadLeaderboardData(); // Refresh leaderboard
      }

      async function initGame() {
        try {
          await loadDictionaries();
          const layoutText = document.getElementById("keyboard-layout-text");
          if (layoutText) {
            layoutText.textContent = keyboardLayout.toUpperCase();
          }
          TARGET_WORD = getDailyWord();

          // Check if already played today
          if (hasPlayedToday()) {
            loadCompletedGame();
            return;
          }

          updateStreakIndicator();

          // Setup game but don't start timer
          resetSlotConstraints();
          intelUsed = false;
          createBoard();
          createKeyboard();
          document.addEventListener("keydown", handleKeydown);
          updateActiveRow();
          updateKeyboardVisuals();

          // Show appropriate modal
          if (!localStorage.getItem("tumblerTutorialSeen")) {
            showTutorial(); // First-time: tutorial ‚Üí timer starts when closed
            localStorage.setItem("tumblerTutorialSeen", "true");
          } else {
            showReadyModal(); // Returning users: ready modal ‚Üí timer starts when clicked
          }
        } catch (error) {
          console.error("Game Initialization Error:", error);
          showMessage("Error loading word lists. Please refresh.");
        }
      }

      function startTimer() {
        const timerElement = document.getElementById("timer");
        const timerDisplay = document.querySelector(".timer-display");
        startTime = Date.now();

        timerInterval = setInterval(() => {
          if (isGameOver) {
            clearInterval(timerInterval);
            return;
          }

          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;

          timerElement.textContent = `${String(minutes).padStart(
            2,
            "0"
          )}:${String(seconds).padStart(2, "0")}`;

          // Visual feedback based on time
          timerDisplay.classList.remove("warning", "danger");
          if (elapsed >= 120) {
            // 2 minutes
            timerDisplay.classList.add("danger");
          } else if (elapsed >= 60) {
            // 1 minute
            timerDisplay.classList.add("warning");
          }
        }, 1000);
      }

      // ADD THIS FUNCTION
      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      // Get current puzzle number (days since epoch)
      function getPuzzleNumber(dateObj = new Date()) {
        const msPerDay = 24 * 60 * 60 * 1000;
        const currentMidnight = new Date(dateObj).setHours(0, 0, 0, 0);
        const launchMidnight = new Date(GAME_EPOCH).setHours(0, 0, 0, 0);
        const daysPassed = Math.floor(
          (currentMidnight - launchMidnight) / msPerDay
        );
        return daysPassed + 1;
      }

      function getStorageKey(dateObj) {
        // Use local time components to ensure stability across page reloads
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
        const day = String(dateObj.getDate()).padStart(2, "0");
        return `tumblerGame_${year}-${month}-${day}`;
      }

      function resetIntelUI() {
        // 1. Hide the panel
        document.getElementById("intel-panel").style.display = "none";
        document.getElementById("code-sum-value").textContent = "0";
        document.getElementById("current-sum-value").textContent = "0";

        // 2. Reset the button to "Fresh" state
        const btn = document.getElementById("intel-btn");
        btn.style.display = "block"; // Ensure it's visible
        btn.disabled = false;
        btn.innerHTML = `
                     üîç VIEW INTEL
                     <span style="display:block;font-size:0.75rem;opacity:0.8;margin-top:3px;">
                       Costs $1,500
                     </span>
                   `;
        btn.style.opacity = "1";
        btn.style.cursor = "pointer";
      }

      // Save today's game state
      function saveTodayGame(attempts, cashWon, solveTime) {
        const puzzleNum = getPuzzleNumber(currentPlayDate);

        // Save the actual game grid for display
        const gridState = [];
        for (let r = 0; r < attempts; r++) {
          const rowState = [];
          for (let c = 0; c < WORD_LENGTH; c++) {
            const tile = document.getElementById(`row-${r}-tile-${c}`);
            if (tile) {
              const letterEl = tile.querySelector(".letter");
              rowState.push({
                letter: letterEl ? letterEl.textContent : "",
                status: tile.classList.contains("correct")
                  ? "correct"
                  : tile.classList.contains("close")
                  ? "close"
                  : tile.classList.contains("far")
                  ? "far"
                  : "",
              });
            }
          }
          gridState.push(rowState);
        }

        const gameData = {
          puzzleNumber: puzzleNum,
          attempts: attempts,
          cashWon: cashWon || 0,
          grid: gridState,
          timestamp: Date.now(),
          intelUsed: intelUsed,
          solveTime: solveTime || 0,
        };
        localStorage.setItem(
          getStorageKey(currentPlayDate),
          JSON.stringify(gameData)
        );
      }

      // Check if already played today
      function hasPlayedToday() {
        const saved = localStorage.getItem(getStorageKey(currentPlayDate));
        if (!saved) return false;
        // We don't need to check puzzleNumber anymore since the Key is the date
        return true;
      }
      window.hasPlayedToday = hasPlayedToday;

      function loadCompletedGame() {
        const key = getStorageKey(currentPlayDate);
        const saved = localStorage.getItem(key);
        if (!saved) return;

        const gameData = JSON.parse(saved);

        // 1. Set Global Game State
        isGameOver = true;
        currentRow = gameData.attempts;
        intelUsed = gameData.intelUsed || false;

        // 2. Stop Interactions
        document.removeEventListener("keydown", handleKeydown);
        stopTimer(); // Ensure the timer stops visually

        // 3. Rebuild the Grid
        document.getElementById("game-board").innerHTML = ""; // Clear current board
        createBoard();

        // 4. Populate Grid with Saved Data
        if (gameData.grid && gameData.grid.length > 0) {
          const targetArr = TARGET_WORD.split(""); // Needed to re-calculate arrows

          gameData.grid.forEach((row, rowIndex) => {
            row.forEach((tileData, colIndex) => {
              const tile = document.getElementById(
                `row-${rowIndex}-tile-${colIndex}`
              );

              if (tile && tileData.letter) {
                // Set Letter
                tile.querySelector(".letter").textContent = tileData.letter;
                tile.setAttribute("data-status", "filled");
                tile.classList.add("evaluated");

                // Set Keyboard Color
                const key = document.getElementById(`key-${tileData.letter}`);

                // Re-apply Visual Classes & Indicators
                if (tileData.status) {
                  tile.classList.add(tileData.status);

                  if (tileData.status === "correct") {
                    if (key) key.classList.add("correct");
                  }
                  // Re-calculate arrows for Close/Far (since save data might miss up/down)
                  else if (
                    tileData.status === "close" ||
                    tileData.status === "far"
                  ) {
                    const guessVal = tileData.letter.charCodeAt(0);
                    const targetVal = targetArr[colIndex].charCodeAt(0);
                    const diff = targetVal - guessVal;

                    // Add Up/Down rotation
                    const rotateClass = diff > 0 ? "up" : "down";
                    tile.classList.add(rotateClass);

                    // Add Arrow Indicator
                    const indicator = tile.querySelector(".indicator");
                    let symbol = "";
                    if (Math.abs(diff) > 9) {
                      // Far
                      symbol = diff > 0 ? "‚ñ≤‚ñ≤" : "‚ñº‚ñº";
                    } else {
                      // Close
                      symbol = diff > 0 ? "‚ñ≤" : "‚ñº";
                    }
                    indicator.innerHTML = symbol;
                  }
                }
              }
            });
          });

          // 5. Highlight the winning row (if it was a win)
          // We assume it's a win if the last played row matches the target
          const lastRowIndex = gameData.attempts - 1;
          if (lastRowIndex >= 0 && lastRowIndex < MAX_TRIES) {
            // Simple check: If the user won, usually the last row is all green.
            // Or we can just check if cashWon > 0
            if (gameData.cashWon > 0) {
              const winRow = document.getElementById(`row-${lastRowIndex}`);
              if (winRow) {
                winRow.style.borderColor = "#6aaa64";
                winRow.style.boxShadow = "0 0 30px rgba(106, 170, 100, 0.6)";
              }
            }
          }
        }

        // 6. Handle Intel UI State
        const intelBtn = document.getElementById("intel-btn");
        const intelPanel = document.getElementById("intel-panel");

        if (intelUsed) {
          // Show panel with data
          intelPanel.style.display = "block";
          const targetSum = TARGET_WORD.split("").reduce(
            (sum, char) => sum + (char.charCodeAt(0) - 64),
            0
          );
          document.getElementById("code-sum-value").textContent = targetSum;

          // Hide buy button
          intelBtn.style.display = "none";
        } else {
          // Hide both if game over and no intel used
          intelPanel.style.display = "none";
          intelBtn.style.display = "none";
        }

        // 7. Show Countdown & Modal
        showCountdownMessage(gameData);

        // Auto-open win modal after short delay
        setTimeout(() => {
          showWinModal(
            gameData.attempts,
            gameData.cashWon,
            gameData.solveTime || 0
          );
        }, 1500);
      }

      // NEW: Show countdown and streak when game already played
      // NEW: Show countdown and streak when game already played
      function showCountdownMessage(gameData) {
        const puzzleNum = getPuzzleNumber();
        const cashString = new Intl.NumberFormat("en-US").format(
          gameData.cashWon
        );

        // Calculate time until next puzzle
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        const msUntilTomorrow = tomorrow - now;

        const hours = Math.floor(msUntilTomorrow / (1000 * 60 * 60));
        const minutes = Math.floor(
          (msUntilTomorrow % (1000 * 60 * 60)) / (1000 * 60)
        );
        const seconds = Math.floor((msUntilTomorrow % (1000 * 60)) / 1000);

        // Create a container ABOVE the game board
        const countdownContainer = document.createElement("div");
        countdownContainer.id = "countdown-container";
        countdownContainer.style.cssText =
          "width: 100%; display: flex; justify-content: center; margin-bottom: 15px;";

        countdownContainer.innerHTML = `
                    <div class="countdown-display">
                      <div class="countdown-label">‚úÖ Tumbler #${puzzleNum} Cracked!</div>
                      <div style="font-size: 1.2rem; color: var(--color-cash); margin: 10px 0;">
                        üí∞ $${cashString} Stolen
                      </div>
                      <div class="countdown-label" style="margin-top: 15px;">Next Heist Available In</div>
                      <div class="countdown-timer" id="live-countdown">
                        ${String(hours).padStart(2, "0")}:${String(
          minutes
        ).padStart(2, "0")}:${String(seconds).padStart(2, "0")}
                      </div>
                      <div class="streak-badge">
                        üî• ${stats.currentStreak} Day Streak
                      </div>
                    </div>
                  `;

        // Insert BEFORE the game board
        const gameBoard = document.getElementById("game-board");
        gameBoard.parentNode.insertBefore(countdownContainer, gameBoard);

        // Update countdown every second
        setInterval(() => {
          const now = new Date();
          const tomorrow = new Date(now);
          tomorrow.setDate(tomorrow.getDate() + 1);
          tomorrow.setHours(0, 0, 0, 0);
          const msUntilTomorrow = tomorrow - now;

          const h = Math.floor(msUntilTomorrow / (1000 * 60 * 60));
          const m = Math.floor(
            (msUntilTomorrow % (1000 * 60 * 60)) / (1000 * 60)
          );
          const s = Math.floor((msUntilTomorrow % (1000 * 60)) / 1000);

          const countdownEl = document.getElementById("live-countdown");
          if (countdownEl) {
            countdownEl.textContent = `${String(h).padStart(2, "0")}:${String(
              m
            ).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
          }
        }, 1000);
        updateStreakIndicator();
      }

      function generateShareText(attempts, cashWon) {
        const puzzleNum = getPuzzleNumber();
        const totalCash = stats.totalCash || 0;
        const safeCashWon = cashWon || 0;

        let shareText = `Tumbler #${puzzleNum} üîì\n`;
        shareText += `üí∞ Stole: $${new Intl.NumberFormat("en-US").format(
          safeCashWon
        )}\n`;

        // ADD THESE LINES
        if (intelUsed) {
          shareText += `üîç Intel Used (-$1,500)\n`;
        } else {
          shareText += `üíé No Intel Used\n`;
        }

        shareText += `üî• Streak: ${stats.currentStreak} days\n`;
        shareText += `üíº Total Stash: $${new Intl.NumberFormat("en-US").format(
          totalCash
        )}\n\n`;

        // Generate grid with simple arrows and locks
        for (let r = 0; r < attempts; r++) {
          for (let c = 0; c < WORD_LENGTH; c++) {
            const tile = document.getElementById(`row-${r}-tile-${c}`);
            if (!tile) continue;
            if (tile.classList.contains("correct")) {
              shareText += "üîí"; // Lock for correct
            } else if (
              tile.classList.contains("close") ||
              tile.classList.contains("far")
            ) {
              const hasUp = tile.classList.contains("up");
              shareText += hasUp ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";
            }
          }
          shareText += "\n";
        }

        shareText += `\nPlay: https://akashramsankar.github.io/Tumbler/`;

        return shareText;
      }

      async function shareResult() {
        const saved = localStorage.getItem(getStorageKey(currentPlayDate));
        if (!saved) {
          showMessage("No game data to share!");
          return;
        }

        const gameData = JSON.parse(saved);

        // Validate game data
        if (!gameData.attempts || gameData.cashWon === undefined) {
          showMessage("Invalid game data!");
          return;
        }

        const shareText = generateShareText(
          gameData.attempts,
          gameData.cashWon
        );

        // Check if Web Share API is available AND if sharing text is supported
        if (
          navigator.share &&
          navigator.canShare &&
          navigator.canShare({ text: shareText })
        ) {
          try {
            await navigator.share({ text: shareText });
            showMessage("‚úÖ Shared successfully!");
          } catch (err) {
            // Only fall back to clipboard if user didn't cancel
            if (err.name !== "AbortError") {
              copyToClipboard(shareText);
            }
          }
        } else {
          // Fallback to clipboard for devices without share support
          copyToClipboard(shareText);
        }
      }

      function copyToClipboard(text) {
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard
            .writeText(text)
            .then(() => {
              showMessage("üìã Copied to clipboard!");
            })
            .catch(() => {
              // Fallback to older method
              fallbackCopyToClipboard(text);
            });
        } else {
          // Use fallback for older browsers or non-secure contexts
          fallbackCopyToClipboard(text);
        }
      }

      // Add this NEW function right after copyToClipboard
      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          const successful = document.execCommand("copy");
          if (successful) {
            showMessage("üìã Copied to clipboard!");
          } else {
            showMessage("‚ùå Failed to copy");
          }
        } catch (err) {
          console.error("Fallback copy failed:", err);
          showMessage("‚ùå Failed to copy");
        }

        document.body.removeChild(textArea);
      }

      async function loadDictionaries() {
        const dictResponse = await fetch("4-letter-words.json");
        const dictData = await dictResponse.json();
        dictionary = new Set(dictData.map((w) => w.toUpperCase()));

        const answersResponse = await fetch("Common-used.json");
        const answersData = await answersResponse.json();
        answerList = answersData.map((w) => w.toUpperCase());
      }

      function getDailyWord(dateObj = new Date()) {
        // Accepts date argument
        const msPerDay = 24 * 60 * 60 * 1000;

        // Normalize dates to midnight
        const targetMidnight = new Date(dateObj).setHours(0, 0, 0, 0);
        const epochMidnight = new Date(GAME_EPOCH).setHours(0, 0, 0, 0);

        const timeDiff = targetMidnight - epochMidnight;
        const daysPassed = Math.floor(timeDiff / msPerDay);

        // Reuse your existing manualWords array
        const manualWords = [
          "ROCK",
          "SOUL",
          "FIRE",
          "THIS",
          "OPEN",
          "MINT",
          "GOLD",
          "SAFE",
          "CODE",
          "LINK",
          "BEST",
          "TIME",
          "HACK",
          "DATA",
          "BYTE",
          "NODE",
          "GIRL",
          "BOSS",
          "PLAN",
          "RISK",
          "TEAM",
          "BULK",
          "EVIL",
          "ZERO",
          "FILM",
          "WALL",
          "CASH",
          "DROP",
          "MAST",
          "FANG",
          "LIST",
          "PUMP",
          "WIFE",
          "DUST",
          "LUCK",
          "ALSO",
          "CREW",
          "MASK",
          "DEED",
          "MOON",
          "THIN",
          "JUMP",
          "BOLT",
          "RIDE",
          "SICK",
          "RUST",
        ];

        const index = daysPassed % manualWords.length;
        const safeIndex = index < 0 ? index + manualWords.length : index;

        return manualWords[safeIndex];
      }

      // NEW: Function to calculate cash prize
      function calculateCash(attempts, timeInSeconds) {
        // Check if we are playing today's date
        const isToday =
          new Date().setHours(0, 0, 0, 0) ===
          currentPlayDate.setHours(0, 0, 0, 0);

        let cash = CASH_BASE_VALUE - attempts * CASH_ATTEMPT_PENALTY;
        cash +=
          Math.max(0, CASH_SPEED_BONUS_CAP - timeInSeconds) *
          CASH_PER_SECOND_BONUS;
        if (intelUsed) cash -= INTEL_COST;

        // IF ARCHIVE GAME: 10% Payout
        if (!isToday) {
          return Math.floor(Math.max(CASH_MINIMUM_PAYOUT, cash) * 0.1);
        }

        return Math.max(CASH_MINIMUM_PAYOUT, cash);
      }

      function resetSlotConstraints() {
        slotConstraints = Array.from({ length: WORD_LENGTH }, () => ({
          min: ASCII_A,
          max: ASCII_Z,
        }));
      }

      function createBoard() {
        for (let r = 0; r < MAX_TRIES; r++) {
          const rowDiv = document.createElement("div");
          rowDiv.classList.add("row");
          rowDiv.setAttribute("id", `row-${r}`);

          for (let c = 0; c < WORD_LENGTH; c++) {
            const tileDiv = document.createElement("div");
            tileDiv.classList.add("tile");
            tileDiv.setAttribute("id", `row-${r}-tile-${c}`);

            const letterSpan = document.createElement("span");
            letterSpan.classList.add("letter");
            tileDiv.appendChild(letterSpan);

            const indicatorSpan = document.createElement("span");
            indicatorSpan.classList.add("indicator");
            tileDiv.appendChild(indicatorSpan);

            rowDiv.appendChild(tileDiv);
          }
          board.appendChild(rowDiv);
        }
      }

      function updateActiveRow() {
        document
          .querySelectorAll(".row")
          .forEach((row) => row.classList.remove("active"));
        if (!isGameOver && currentRow < MAX_TRIES) {
          const row = document.getElementById(`row-${currentRow}`);
          if (row) row.classList.add("active");
        }
      }

      function createKey(content, className) {
        const button = document.createElement("button");
        button.textContent = content;
        button.classList.add("key");
        if (className) button.classList.add(className);
        if (!className && content.length === 1) {
          button.setAttribute(
            "data-value",
            content.charCodeAt(0) - ASCII_A + 1
          );
        }
        return button;
      }

      function createKeyboard() {
        keyboardContainer.innerHTML = ""; // Clear existing keyboard

        const layouts = {
          abc: ["ABCDEFGHIJ", "KLMNOPQRST", "UVWXYZ"],
          qwerty: ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"],
        };

        const rows = layouts[keyboardLayout];

        rows.forEach((rowString, index) => {
          const rowDiv = document.createElement("div");
          rowDiv.classList.add("key-row");

          if (index === 2) {
            const enterKey = createKey("ENTER", "wide");
            enterKey.onclick = (e) => {
              e.preventDefault();
              e.stopPropagation();
              submitGuess();
            };
            rowDiv.appendChild(enterKey);
          }

          for (let char of rowString) {
            const key = createKey(char, "");
            key.id = `key-${char}`;
            key.onclick = (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (!isGameOver && currentTile < WORD_LENGTH) {
                addLetter(char);
              }
            };
            rowDiv.appendChild(key);
          }

          if (index === 2) {
            const backKey = createKey("‚å´", "wide");
            backKey.onclick = (e) => {
              e.preventDefault();
              e.stopPropagation();
              deleteLetter();
            };
            rowDiv.appendChild(backKey);
          }
          keyboardContainer.appendChild(rowDiv);
        });
      }

      function toggleKeyboardLayout() {
        keyboardLayout = keyboardLayout === "abc" ? "qwerty" : "abc";
        localStorage.setItem("tumblerKeyboardLayout", keyboardLayout);

        // Update button text
        const layoutText = document.getElementById("keyboard-layout-text");
        if (layoutText) {
          layoutText.textContent = keyboardLayout.toUpperCase();
        }

        // Store current keyboard state (which keys are colored/disabled)
        const keyStates = {};
        document.querySelectorAll(".key").forEach((key) => {
          if (!key.classList.contains("wide")) {
            const letter = key.textContent;
            keyStates[letter] = {
              correct: key.classList.contains("correct"),
              disabled: key.hasAttribute("data-disabled"),
              value: key.getAttribute("data-value"),
            };
          }
        });

        // Recreate keyboard with new layout
        createKeyboard();

        // Restore key states
        Object.keys(keyStates).forEach((letter) => {
          const key = document.getElementById(`key-${letter}`);
          if (key) {
            if (keyStates[letter].correct) {
              key.classList.add("correct");
            }
            if (keyStates[letter].disabled) {
              key.setAttribute("data-disabled", "true");
            }
            if (keyStates[letter].value) {
              key.setAttribute("data-value", keyStates[letter].value);
            }
          }
        });

        playSound("keypress");
      }

      function updateKeyboardVisuals() {
        if (isGameOver || currentRow >= MAX_TRIES) return;

        if (currentTile >= WORD_LENGTH) {
          document.querySelectorAll(".key").forEach((k) => {
            k.removeAttribute("data-disabled");
          });
          return;
        }

        const range = slotConstraints[currentTile];
        if (!range) return;

        document.querySelectorAll(".key").forEach((key) => {
          if (key.classList.contains("wide")) return;

          const keyVal = key.textContent.charCodeAt(0);
          const isOutOfRange = keyVal < range.min || keyVal > range.max;

          // NEW: Even correct (green) keys get disabled if out of range for current position
          if (isOutOfRange) {
            key.setAttribute("data-disabled", "true");
          } else {
            key.removeAttribute("data-disabled");
          }
        });
      }

      function addLetter(letter) {
        if (isGameOver) return;
        if (currentTile >= WORD_LENGTH) return;

        const keyEl = document.getElementById(`key-${letter}`);
        if (keyEl && keyEl.hasAttribute("data-disabled")) {
          showMessage("Invalid letter for this position!");
          shakeRow();
          playSound("error");
          return;
        }

        guesses[currentRow][currentTile] = letter;
        const tile = document.getElementById(
          `row-${currentRow}-tile-${currentTile}`
        );

        if (!tile) return;

        tile.querySelector(".letter").textContent = letter;
        tile.setAttribute("data-status", "filled");
        currentTile++;

        playSound("keypress");

        updateKeyboardVisuals();
        updateCurrentSum();
      }

      function deleteLetter() {
        if (isGameOver) return;
        if (currentTile > 0) {
          currentTile--;
          guesses[currentRow][currentTile] = "";
          const tile = document.getElementById(
            `row-${currentRow}-tile-${currentTile}`
          );
          tile.querySelector(".letter").textContent = "";
          tile.removeAttribute("data-status");

          updateKeyboardVisuals();
          updateCurrentSum();
        }
      }

      function updateCurrentSum() {
        if (!intelUsed) return;

        const currentSumEl = document.getElementById("current-sum-value");
        if (!currentSumEl) return;

        let sum = 0;
        for (let i = 0; i < currentTile; i++) {
          const letter = guesses[currentRow][i];
          if (letter) {
            sum += letter.charCodeAt(0) - ASCII_A + 1;
          }
        }

        currentSumEl.textContent = sum;
      }

      function showMessage(msg) {
        messageContainer.innerHTML = `<div class="toast">${msg}</div>`;
        setTimeout(() => (messageContainer.innerHTML = ""), 2000);
      }

      function shakeRow() {
        const row = document.getElementById(`row-${currentRow}`);
        row.style.transform = "translateX(5px)";
        setTimeout(() => (row.style.transform = "translateX(-5px)"), 100);
        setTimeout(() => (row.style.transform = "translateX(5px)"), 200);
        setTimeout(() => (row.style.transform = "translateX(0)"), 300);
      }

      function submitGuess() {
        if (isGameOver) return;

        // NEW: Prevent duplicate submissions during evaluation
        if (document.querySelector(".row.evaluating")) {
          return;
        }

        if (currentTile < WORD_LENGTH) {
          showMessage("Need full combination!");
          shakeRow();
          playSound("error");
          return;
        }

        const currentWord = guesses[currentRow].join("");
        if (!dictionary.has(currentWord)) {
          showMessage("Not in word list!");
          shakeRow();
          playSound("error");
          return;
        }

        // NEW: Mark row as being evaluated
        const row = document.getElementById(`row-${currentRow}`);
        row.classList.add("evaluating");

        evaluateGuess(guesses[currentRow]);
      }

      function evaluateGuess(guessArr) {
        const targetArr = TARGET_WORD.split("");
        let correctCount = 0;

        for (let i = 0; i < WORD_LENGTH; i++) {
          const tile = document.getElementById(`row-${currentRow}-tile-${i}`);
          const indicator = tile.querySelector(".indicator");
          const letter = guessArr[i];

          const guessVal = letter.charCodeAt(0);
          const targetVal = targetArr[i].charCodeAt(0);
          const diff = targetVal - guessVal;

          const key = document.getElementById(`key-${letter}`);

          applyFeedbackConstraint(i, guessVal, diff);

          setTimeout(() => {
            tile.classList.add("evaluated");

            if (diff === 0) {
              tile.classList.add("correct");
              correctCount++;
              if (key) key.classList.add("correct");
              playSound("correct");
            } else {
              let symbol = "";
              let distClass = "";
              let rotateClass = diff > 0 ? "up" : "down";

              if (Math.abs(diff) > 9) {
                distClass = "far";
                symbol = diff > 0 ? "‚ñ≤‚ñ≤" : "‚ñº‚ñº";
                playSound("far");
              } else {
                distClass = "close";
                symbol = diff > 0 ? "‚ñ≤" : "‚ñº";
                playSound("close");
              }

              tile.classList.add(distClass);
              tile.classList.add(rotateClass);
              indicator.innerHTML = symbol;
            }
          }, i * 200);
        }

        setTimeout(() => {
          if (correctCount === WORD_LENGTH) {
            isGameOver = true;
            document
              .querySelector(".row.evaluating")
              ?.classList.remove("evaluating");
            playSound("win");
            stopTimer();
            const solveTime = Math.floor((Date.now() - startTime) / 1000);
            const cashWon = calculateCash(currentRow + 1, solveTime);

            // Update Stats
            const isToday =
              new Date().setHours(0, 0, 0, 0) ===
              currentPlayDate.setHours(0, 0, 0, 0);
            if (isToday) {
              stats.played++;
              stats.won++;
              if (wasYesterdayPlayed()) {
                stats.currentStreak++;
              } else {
                if (stats.streakProtectors > 0) {
                  stats.streakProtectors--;
                  stats.currentStreak++;
                  showMessage("üõ°Ô∏è Streak Protector Used!");
                } else {
                  stats.currentStreak = 1;
                }
              }

              // Check for milestone bonus
              const milestoneBonus = awardStreakBonus();
              if (milestoneBonus > 0) {
                setTimeout(() => {
                  showMessage(
                    `üéâ ${
                      stats.currentStreak
                    } DAY MILESTONE! +$${milestoneBonus.toLocaleString()} BONUS!`
                  );
                }, 2000);
              }
            } else {
              // Archive games: still count wins and cash, but don't affect streak or played count
              stats.archiveWon++;
            }
            stats.maxStreak = Math.max(stats.maxStreak, stats.currentStreak);
            stats.guessDistribution[currentRow]++;
            stats.totalCash += cashWon;
            saveTodayGame(currentRow + 1, cashWon, solveTime);
            localStorage.setItem("tumblerStats", JSON.stringify(stats));

            if (window.submitScoreToFirebase) {
              window.submitScoreToFirebase(
                currentRow + 1,
                cashWon,
                solveTime,
                intelUsed
              );
            }

            if (isToday && db && userGroups.length > 0) {
              userGroups.forEach((group) => {
                calculateWeeklyBadges(group);
              });
            }

            // ===== ENHANCED WIN ANIMATION =====
            const currentRowEl = document.getElementById(`row-${currentRow}`);

            // Screen flash
            createScreenFlash();

            // Pulsing glow on winning row
            currentRowEl.classList.add("win-glow");
            currentRowEl.style.borderColor = "#6aaa64";
            currentRowEl.style.transition = "all 0.3s ease";
            // Animate each tile with stagger
            for (let i = 0; i < WORD_LENGTH; i++) {
              const tile = document.getElementById(
                `row-${currentRow}-tile-${i}`
              );
              setTimeout(() => {
                tile.style.transform = "rotate(720deg) scale(1.2)";
                tile.style.boxShadow = "0 0 20px rgba(106, 170, 100, 0.8)";
              }, i * 100);
            }

            // Start confetti and cash rain
            setTimeout(() => {
              createConfetti();
              createCashRain();
            }, 400);

            // Show win modal with animated counter
            setTimeout(() => {
              showWinModal(currentRow + 1, cashWon, solveTime);
            }, WORD_LENGTH * 200 + 800);
          } else {
            document
              .querySelector(".row.evaluating")
              ?.classList.remove("evaluating");

            if (currentRow < MAX_TRIES - 1) {
              currentRow++;
              currentTile = 0;
              updateActiveRow();
              updateKeyboardVisuals();
            } else {
              const isToday =
                new Date().setHours(0, 0, 0, 0) ===
                currentPlayDate.setHours(0, 0, 0, 0);
              if (isToday) {
                stats.played++;
                stats.currentStreak = 0;
              }
              stopTimer();
              localStorage.setItem("tumblerStats", JSON.stringify(stats));

              // ADD THIS LINE BELOW:
              saveTodayGame(MAX_TRIES, 0, 0);

              showMessage(`üö® ALARM! Code was: ${TARGET_WORD}`);
              isGameOver = true;
            }
          }
        }, WORD_LENGTH * 200 + 300);
      }

      function handleKeydown(e) {
        const key = e.key.toUpperCase();
        if (key === "ENTER") submitGuess();
        else if (key === "BACKSPACE") deleteLetter();
        else if (/^[A-Z]$/.test(key)) addLetter(key);
      }

      function applyFeedbackConstraint(slotIndex, guessVal, diff) {
        const constraint = slotConstraints[slotIndex];
        if (!constraint) return;

        if (diff === 0) {
          constraint.min = guessVal;
          constraint.max = guessVal;
          return;
        }

        const absDiff = Math.abs(diff);
        if (diff > 0) {
          const step = absDiff > CLOSE_DISTANCE ? FAR_DISTANCE : 1;
          const newMin = Math.min(guessVal + step, ASCII_Z);
          constraint.min = Math.max(constraint.min, newMin);

          if (absDiff <= CLOSE_DISTANCE) {
            const newMax = Math.min(guessVal + CLOSE_DISTANCE, ASCII_Z);
            constraint.max = Math.min(constraint.max, newMax);
          }
        } else {
          const step = absDiff > CLOSE_DISTANCE ? FAR_DISTANCE : 1;
          const newMax = Math.max(guessVal - step, ASCII_A);
          constraint.max = Math.min(constraint.max, newMax);

          if (absDiff <= CLOSE_DISTANCE) {
            const newMin = Math.max(guessVal - CLOSE_DISTANCE, ASCII_A);
            constraint.min = Math.max(constraint.min, newMin);
          }
        }

        constraint.min = Math.min(Math.max(constraint.min, ASCII_A), ASCII_Z);
        constraint.max = Math.max(Math.min(constraint.max, ASCII_Z), ASCII_A);

        if (constraint.min > constraint.max) {
          constraint.min = constraint.max;
        }
      }

      function showJoinNewCrew() {
        // Show the setup form for joining a new crew
        document.getElementById("view-setup").style.display = "block";
        document.getElementById("group-id").value = ""; // Clear crew ID field
        document.getElementById("group-id").focus();

        // Change button text
        const joinBtn = document.querySelector("#view-setup .group-action-btn");
        joinBtn.textContent = "Join New Crew";
      }

      function hideJoinNewCrew() {
        document.getElementById("view-setup").style.display = "none";
      }

      function showStats() {
        const modal = document.getElementById("stats-modal");
        modal.style.display = "flex";

        // Format cash for display
        const safeTotalCash = stats.totalCash || 0;
        const totalCashString = new Intl.NumberFormat("en-US").format(
          safeTotalCash
        );

        document.getElementById(
          "stat-total-cash"
        ).textContent = `$${totalCashString}`;
        document.getElementById("stat-played").textContent = stats.played;
        document.getElementById("stat-winrate").textContent =
          stats.played > 0
            ? Math.min(100, Math.round((stats.won / stats.played) * 100))
            : 0;
        document.getElementById("stat-streak").textContent =
          stats.currentStreak;
        // Update protector display
        // Update protector display
        const protectorCount = document.getElementById("protector-count");
        if (protectorCount) {
          protectorCount.textContent = stats.streakProtectors;
        }

        // Check protector purchase availability
        const protectorBtn = document.getElementById("protector-btn");
        if (protectorBtn) {
          const now = Date.now();
          const oneMonth = 30 * 24 * 60 * 60 * 1000;
          const timeSinceLastPurchase =
            now - (stats.lastProtectorPurchase || 0);

          if (timeSinceLastPurchase < oneMonth) {
            const daysRemaining = Math.ceil(
              (oneMonth - timeSinceLastPurchase) / (24 * 60 * 60 * 1000)
            );
            protectorBtn.disabled = true;
            protectorBtn.style.opacity = "0.5";
            protectorBtn.innerHTML = `Buy Insurance<br><span style="opacity: 0.8;">Available in ${daysRemaining}d</span>`;
          } else {
            protectorBtn.disabled = false;
            protectorBtn.style.opacity = "1";
            protectorBtn.innerHTML = `Buy Insurance<br><span style="opacity: 0.8;">$50,000</span>`;
          }
        }

        // Enable/disable recovery button
        const recoveryBtn = document.getElementById("recovery-btn");
        if (recoveryBtn) {
          if (stats.currentStreak === 0 && wasYesterdayPlayed()) {
            recoveryBtn.disabled = false;
            recoveryBtn.style.opacity = "1";
          } else {
            recoveryBtn.disabled = true;
            recoveryBtn.style.opacity = "0.5";
          }
        }
      }

      // MODIFIED: Show Stats now displays total cash
      function showWinModal(attempts, cashWon, solveTime) {
        const modal = document.getElementById("win-modal");
        modal.style.display = "flex";

        const isToday =
          new Date().setHours(0, 0, 0, 0) ===
          currentPlayDate.setHours(0, 0, 0, 0);

        const shareBtn = document.getElementById("share-result-btn");
        if (shareBtn) {
          shareBtn.style.display = isToday ? "block" : "none";
        }

        // Calculate breakdown components
        const penalties = attempts * CASH_ATTEMPT_PENALTY;
        const timeBonus =
          Math.max(0, CASH_SPEED_BONUS_CAP - solveTime) * CASH_PER_SECOND_BONUS;

        // Update breakdown display
        document.getElementById(
          "win-penalties"
        ).textContent = `-$${penalties.toLocaleString()}`;
        document.getElementById(
          "win-speed-bonus"
        ).textContent = `+$${timeBonus.toLocaleString()}`;

        // Show/hide intel cost row
        const intelRow = document.getElementById("intel-cost-row");
        if (intelUsed) {
          intelRow.style.display = "flex";
        } else {
          intelRow.style.display = "none";
        }

        // Ensure cashWon is a valid number
        const safeCashWon = cashWon || 0;
        const safeTotalCash = stats.totalCash || 0;

        // Animate the final take counter
        animateCountUp("win-cash-earned", safeCashWon, 2000);

        document.getElementById("win-attempts").textContent = attempts;
        document.getElementById("win-time").textContent = `${solveTime}s`;

        // Animate total stash too
        animateCountUp("win-total-cash", safeTotalCash, 2000);
        document.getElementById(
          "win-total-cash"
        ).textContent = `$${new Intl.NumberFormat("en-US").format(
          stats.totalCash
        )}`;

        // Show milestone achievement
        const { isAtMilestone, currentStreak } = checkStreakMilestone();
        if (isAtMilestone && stats.lastStreakMilestone === currentStreak) {
          const bonus = currentStreak * STREAK_BONUS_PER_MILESTONE;

          const stashDisplay = document.querySelector(
            "#win-modal .stash-display"
          );
          const milestoneDiv = document.createElement("div");
          milestoneDiv.style.cssText =
            "background: linear-gradient(135deg, #6aaa64, #538d4e); padding: 12px; border-radius: 10px; margin-top: 15px; text-align: center; border: 2px solid var(--color-correct); box-shadow: 0 0 20px rgba(106, 170, 100, 0.4);";
          milestoneDiv.innerHTML = `
      <div style="font-size: 1.8rem;">üéâ</div>
      <div style="font-size: 1.1rem; font-weight: 700; color: white; margin: 5px 0;">
        ${currentStreak}-DAY MILESTONE!
      </div>
      <div style="font-size: 1.3rem; font-weight: 700; color: var(--color-cash);">
        +$${bonus.toLocaleString()} BONUS
      </div>
    `;

          stashDisplay.parentNode.insertBefore(
            milestoneDiv,
            stashDisplay.nextSibling
          );
        }

        // Update streak indicator
        updateStreakIndicator();

        // Build distribution bars
        const maxGuesses = Math.max(...stats.guessDistribution, 1);
        const barsHTML = stats.guessDistribution
          .map((count, idx) => {
            const percentage = (count / maxGuesses) * 100;
            const width = Math.max(percentage, 10);
            const isCurrent = idx === attempts - 1;
            return `
        <div class="distribution-row">
          <div class="distribution-label">${idx + 1}</div>
          <div class="distribution-bar ${isCurrent ? "current" : ""}"
               style="width: ${width}%">
            ${count}
          </div>
        </div>
      `;
          })
          .join("");

        document.getElementById("distribution-bars").innerHTML = barsHTML;
      }

      function closeWinModal() {
        document.getElementById("win-modal").style.display = "none";
      }
      // ADD ALL THREE FUNCTIONS
      function confirmIntel() {
        if (intelUsed || isGameOver) return;

        const modal = document.createElement("div");
        modal.id = "intel-confirm-modal";
        modal.className = "tutorial-modal";
        modal.style.display = "flex";

        modal.innerHTML = `
                     <div class="tutorial-content" style="max-width: 360px;">
                       <h2 style="margin-top: 0; font-size: 1.5rem;">üîç Purchase Intel?</h2>

                       <div style="background: var(--safe-inset); padding: 15px; border-radius: 10px; margin: 20px 0; border: 1px solid var(--safe-border);">
                         <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 8px;">
                           Reveals code sum to help crack the vault
                         </div>
                         <div style="font-size: 1.8rem; font-weight: 700; color: var(--color-far);">
                           Cost: $1,500
                         </div>
                       </div>

                       <div style="font-size: 0.85rem; color: #cbd5e1; line-height: 1.5; margin-bottom: 20px;">
                         The intel will show you the sum of all letter values (A=1, B=2...Z=26).
                         This will be deducted from your final heist reward.
                       </div>

                       <div style="display: flex; gap: 10px;">
                         <button class="tutorial-btn" onclick="useIntel()" style="flex: 1;">
                           ‚úì Use Intel
                         </button>
                         <button class="close-stats" onclick="closeIntelModal()" style="flex: 1; margin-top: 0;">
                           Cancel
                         </button>
                       </div>
                     </div>
                   `;

        document.body.appendChild(modal);
        modal.addEventListener("click", (e) => {
          if (e.target.id === "intel-confirm-modal") closeIntelModal();
        });
      }

      function closeIntelModal() {
        const modal = document.getElementById("intel-confirm-modal");
        if (modal) modal.remove();
      }

      function useIntel() {
        intelUsed = true;
        closeIntelModal();

        // Calculate target sum (YES - AUTOMATIC!)
        const targetSum = TARGET_WORD.split("").reduce((sum, char) => {
          return sum + (char.charCodeAt(0) - ASCII_A + 1);
        }, 0);

        // Show the intel panel
        const intelPanel = document.getElementById("intel-panel");
        intelPanel.style.display = "block";
        document.getElementById("code-sum-value").textContent = targetSum;

        // Update button
        const btn = document.getElementById("intel-btn");
        btn.disabled = true;
        btn.innerHTML = "‚úì Intel Used (-$1,500)";
        btn.style.opacity = "0.6";
        btn.style.cursor = "default";

        showMessage("üîç Intel decrypted!");
        playSound("keypress");
      }

      function showCalendar() {
        const grid = document.getElementById("calendar-grid");
        grid.innerHTML = "";

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Start from Epoch
        const startDate = new Date(GAME_EPOCH);

        // Loop from Epoch until Today
        for (
          let d = new Date(startDate);
          d <= today;
          d.setDate(d.getDate() + 1)
        ) {
          const tempDate = new Date(d);
          const key = getStorageKey(tempDate);
          const savedData = JSON.parse(localStorage.getItem(key));
          const puzzleNum =
            Math.floor((tempDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

          const dayBtn = document.createElement("div");
          dayBtn.classList.add("cal-day");

          // Check Status
          // Format date as MM/DD
          const dateStr = `${tempDate.getMonth() + 1}/${tempDate.getDate()}`;

          // Check Status
          if (savedData) {
            if (
              savedData.attempts <= 6 &&
              savedData.grid.length === savedData.attempts
            ) {
              dayBtn.classList.add("won");
              dayBtn.innerHTML = `<div class="cal-number">#${puzzleNum}</div><div style="font-size: 0.65rem; margin-top: 2px; opacity: 0.8;">${dateStr}</div><div class="cal-money">$${savedData.cashWon}</div>`;
            } else {
              dayBtn.classList.add("lost");
              dayBtn.innerHTML = `<div class="cal-number">#${puzzleNum}</div><div style="font-size: 0.65rem; margin-top: 2px; opacity: 0.8;">${dateStr}</div><div class="cal-money">FAIL</div>`;
            }
          } else {
            dayBtn.innerHTML = `<div class="cal-number">#${puzzleNum}</div><div style="font-size: 0.65rem; margin-top: 2px; opacity: 0.8;">${dateStr}</div>`;
          }

          // Highlight currently selected date
          if (tempDate.getTime() === currentPlayDate.getTime()) {
            dayBtn.classList.add("current");
          }

          // Click Event
          dayBtn.onclick = () => loadDate(tempDate);
          grid.appendChild(dayBtn);
        }

        // Fill future slots for visual balance (optional, maybe next 5 days)
        for (let i = 0; i < 3; i++) {
          const d = document.createElement("div");
          d.classList.add("cal-day", "future");
          d.innerHTML = `üîí`;
          grid.appendChild(d);
        }

        document.getElementById("calendar-modal").style.display = "flex";
      }

      function closeCalendar() {
        document.getElementById("calendar-modal").style.display = "none";
      }

      function switchCrew() {
        const dropdown = document.getElementById("crew-dropdown");
        activeGroup = dropdown.value;
        localStorage.setItem("tumblerActiveGroup", activeGroup);
        document.getElementById(
          "display-group-name"
        ).textContent = `Crew: ${activeGroup}`;

        // Reload the leaderboard with new crew data
        loadLeaderboardData();
        displayUserBadges();
      }

      async function loadDate(dateObj) {
        closeCalendar();

        // 1. Update Current Date
        currentPlayDate = new Date(dateObj);
        currentPlayDate.setHours(0, 0, 0, 0);

        // 2. Reset Board UI
        document.getElementById("game-board").innerHTML = "";
        document.getElementById("keyboard").innerHTML = "";

        // --- NEW: FORCE RESET INTEL UI HERE ---
        resetIntelUI();
        // --------------------------------------

        guesses = Array(6)
          .fill(null)
          .map(() => Array(4).fill(""));
        currentRow = 0;
        currentTile = 0;
        isGameOver = false;
        intelUsed = false;

        // Remove any existing countdown containers from previous views
        const existingCountdown = document.getElementById(
          "countdown-container"
        );
        if (existingCountdown) existingCountdown.remove();

        // 3. Re-Init Game
        TARGET_WORD = getDailyWord(currentPlayDate);
        createBoard();
        createKeyboard();

        if (hasPlayedToday()) {
          loadCompletedGame();
        } else {
          resetSlotConstraints();
          updateActiveRow();
          updateKeyboardVisuals();
          // Enable keyboard for new games only
          document.addEventListener("keydown", handleKeydown);
          startTimer(); // Ensure timer starts for new games

          // Update header text
          const isToday =
            new Date().setHours(0, 0, 0, 0) ===
            currentPlayDate.setHours(0, 0, 0, 0);
          document.querySelector(".sub-text").textContent = isToday
            ? "Crack the code"
            : `ARCHIVE: ${dateObj.toLocaleDateString()}`;
        }
        updateStreakIndicator();
      }

      function closeStats() {
        document.getElementById("stats-modal").style.display = "none";
      }

      function showTutorial() {
        document.getElementById("tutorial-modal").style.display = "flex";
      }

      function closeTutorial() {
        document.getElementById("tutorial-modal").style.display = "none";
        // Only start timer if it hasn't been started yet
        if (!startTime) {
          startTimer();
        }
      }

      function showReadyModal() {
        const modal = document.getElementById("ready-modal");
        const puzzleNum = getPuzzleNumber(currentPlayDate);

        document.getElementById(
          "ready-puzzle-number"
        ).textContent = `TUMBLER #${puzzleNum}`;
        document.getElementById("ready-streak").textContent =
          stats.currentStreak;
        document.getElementById(
          "ready-cash"
        ).textContent = `$${new Intl.NumberFormat("en-US").format(
          stats.totalCash || 0
        )}`;

        modal.style.display = "flex";
      }

      function startCracking() {
        document.getElementById("ready-modal").style.display = "none";
        startTimer();
      }

      document.getElementById("stats-modal").addEventListener("click", (e) => {
        if (e.target.id === "stats-modal") closeStats();
      });

      document.getElementById("win-modal").addEventListener("click", (e) => {
        if (e.target.id === "win-modal") closeWinModal();
      });

      document
        .getElementById("tutorial-modal")
        .addEventListener("click", (e) => {
          if (e.target.id === "tutorial-modal") closeTutorial();
        });

      document.getElementById("ready-modal").addEventListener("click", (e) => {
        if (e.target.id === "ready-modal") startCracking();
      });

      document
        .getElementById("protector-confirm-modal")
        .addEventListener("click", (e) => {
          if (e.target.id === "protector-confirm-modal") closeProtectorModal();
        });

      document
        .getElementById("recovery-confirm-modal")
        .addEventListener("click", (e) => {
          if (e.target.id === "recovery-confirm-modal") closeRecoveryModal();
        });

      initGame();

      // --- 1. CONFIGURATION ---
      const firebaseConfig = {
        apiKey: "AIzaSyD5C8uPGGb_jMuA0ceP5VlWChMV-Ggfles",
        authDomain: "tumbler-51e42.firebaseapp.com",
        databaseURL:
          "https://tumbler-51e42-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "tumbler-51e42",
        storageBucket: "tumbler-51e42.firebasestorage.app",
        messagingSenderId: "907072959576",
        appId: "1:907072959576:web:641facf27c204c7bb8862d",
        measurementId: "G-J6SL0G5SKR",
      };

      // Initialize Firebase (Standard Mode)
      let db = null;
      try {
        if (typeof firebase !== "undefined") {
          firebase.initializeApp(firebaseConfig);
          db = firebase.database();
          console.log("Firebase initialized successfully.");
        } else {
          console.error("Firebase library not loaded.");
        }
      } catch (e) {
        console.error("Firebase Error:", e);
      }

      // Weekly Badge Definitions
      const WEEKLY_BADGES = {
        champion: { icon: "ü•á", name: "Champion", desc: "#1 This Week" },
        runnerUp: { icon: "ü•à", name: "Runner Up", desc: "#2 This Week" },
        bronze: { icon: "ü•â", name: "Bronze", desc: "#3 This Week" },
        speedKing: { icon: "‚ö°", name: "Speed King", desc: "Fastest Time" },
      };

      const CAREER_BADGES = {
        legend: { icon: "üëë", name: "Legend", desc: "Most Career Wins" },
        vaultMaster: {
          icon: "üíé",
          name: "Vault Master",
          desc: "Highest Single Score",
        },
      };

      // --- 2. STATE ---
      let userNick = localStorage.getItem("tumblerNick") || "";
      let userGroups = JSON.parse(
        localStorage.getItem("tumblerGroups") || "[]"
      ); // Array of crew IDs
      let activeGroup = localStorage.getItem("tumblerActiveGroup") || ""; // Currently viewing crew
      let currentTab = "daily";

      // --- 3. FUNCTIONS ---

      // Get current week key (format: "2025-W01")
      function getWeekKey(date = new Date()) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7)); // Thursday of current week
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNum = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        return `${d.getFullYear()}-W${String(weekNum).padStart(2, "0")}`;
      }

      // Calculate time until next Monday 00:00
      function getTimeUntilMonday() {
        const now = new Date();
        const nextMonday = new Date(now);
        nextMonday.setDate(now.getDate() + ((8 - now.getDay()) % 7 || 7));
        nextMonday.setHours(0, 0, 0, 0);

        const diff = nextMonday - now;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );

        if (days > 0) return `${days}d ${hours}h until reset`;
        return `${hours}h until reset`;
      }

      // Fetch user's badges for active crew
      async function fetchUserBadges() {
        if (!db || !activeGroup || !userNick) return [];

        const badges = [];
        const weekKey = getWeekKey();

        try {
          // Check weekly badges
          const weeklySnapshot = await db
            .ref(`weeklyBadges/${weekKey}/${activeGroup}`)
            .once("value");
          const weeklyData = weeklySnapshot.val();

          if (weeklyData) {
            Object.entries(WEEKLY_BADGES).forEach(([badgeId, badge]) => {
              if (weeklyData[badgeId] === userNick) {
                badges.push({ ...badge, id: badgeId, type: "weekly" });
              }
            });
          }

          // Check career badges
          const careerSnapshot = await db
            .ref(`careerBadges/${activeGroup}`)
            .once("value");
          const careerData = careerSnapshot.val();

          if (careerData) {
            Object.entries(CAREER_BADGES).forEach(([badgeId, badge]) => {
              if (careerData[badgeId] === userNick) {
                badges.push({ ...badge, id: badgeId, type: "career" });
              }
            });
          }
        } catch (e) {
          console.log("Could not fetch badges:", e);
        }

        return badges;
      }

      // Display user's badges
      async function displayUserBadges() {
        const container = document.getElementById("user-badges-display");
        const showcase = document.getElementById("badge-showcase");
        const timer = document.getElementById("weekly-reset-timer");

        if (!container || !showcase) return;

        // ADD THIS CHECK - only show badges if user is in this crew
        if (!userGroups.includes(activeGroup)) {
          showcase.style.display = "none";
          return;
        }

        const badges = await fetchUserBadges();

        if (badges.length === 0) {
          container.innerHTML =
            '<div style="color: #64748b; font-size: 0.85rem;">No badges yet. Start playing!</div>';
          showcase.style.display = "block";
          return;
        }

        container.innerHTML = badges
          .map(
            (badge) => `
    <div class="user-badge-item">
      <span class="user-badge-icon">${badge.icon}</span>
      <span class="user-badge-name">${badge.name}</span>
    </div>
  `
          )
          .join("");

        // Show reset timer
        if (timer) {
          timer.textContent = `‚è∞ ${getTimeUntilMonday()}`;
        }

        showcase.style.display = "block";
      }

      function openGroupModal() {
        document.getElementById("group-modal").style.display = "flex";

        // Check for invite crew in session
        const inviteCrew = sessionStorage.getItem("inviteCrew");
        if (inviteCrew && !userNick) {
          document.getElementById("group-id").value = inviteCrew;
          document.getElementById("group-id").disabled = true;
          document.getElementById("player-nick").focus();
          document.getElementById("view-setup").style.display = "block";
          document.getElementById("view-leaderboard").style.display = "none";
          return;
        }

        if (userNick && userGroups.length > 0) {
          if (!activeGroup) activeGroup = userGroups[0];
          document.getElementById("view-setup").style.display = "none";
          showLeaderboardView();
        } else {
          document.getElementById("view-setup").style.display = "block";
          document.getElementById("view-leaderboard").style.display = "none";
        }
      }

      function closeGroupModal() {
        document.getElementById("group-modal").style.display = "none";
      }

      function shareCrewInvite() {
        const inviteLink = `${window.location.origin}${window.location.pathname}?crew=${activeGroup}`;
        const inviteText = `üîì Join my Tumbler crew "${activeGroup}"!\n\nClick to join: ${inviteLink}`;

        if (navigator.share && navigator.canShare({ text: inviteText })) {
          navigator
            .share({ text: inviteText })
            .then(() => showMessage("‚úÖ Invite shared!"))
            .catch(() => copyToClipboard(inviteLink));
        } else {
          copyToClipboard(inviteLink);
          showMessage("üìã Invite link copied!");
        }
      }

      async function joinGroup() {
        const nick = document
          .getElementById("player-nick")
          .value.trim()
          .toUpperCase();
        const group = document
          .getElementById("group-id")
          .value.trim()
          .toUpperCase();

        if (nick.length < 2 || group.length < 3) {
          alert("Name must be 2+ chars, Crew ID 3+ chars.");
          return;
        }

        // 1. Save Locally
        userNick = nick;
        if (!userGroups.includes(group)) {
          userGroups.push(group);
          localStorage.setItem("tumblerGroups", JSON.stringify(userGroups));
        }
        activeGroup = group;
        localStorage.setItem("tumblerNick", nick);
        localStorage.setItem("tumblerActiveGroup", group);

        // 2. Try Update Firebase (Don't wait for it)
        if (db) {
          db.ref(`groups/${group}/members/${nick}`)
            .update({
              joined: Date.now(),
              lastActive: Date.now(),
            })
            .catch((e) => console.log("Offline mode: Saved locally only"));

          // Sync score if played today
          if (hasPlayedTodayCheck()) {
            syncTodaysScore();
          }
        }

        // Clear invite session and re-enable field
        sessionStorage.removeItem("inviteCrew");
        document.getElementById("group-id").disabled = false;

        // 3. IMMEDIATELY Show View (Fixes the "Nothing Happens" bug)
        showLeaderboardView();

        // Hide the join form after successful join
        hideJoinNewCrew();
      }

      function logoutGroup() {
        if (confirm("Leave this crew?")) {
          userGroups = userGroups.filter((g) => g !== activeGroup);
          localStorage.setItem("tumblerGroups", JSON.stringify(userGroups));

          if (userGroups.length > 0) {
            activeGroup = userGroups[0];
            localStorage.setItem("tumblerActiveGroup", activeGroup);
            showLeaderboardView();
          } else {
            activeGroup = "";
            localStorage.removeItem("tumblerActiveGroup");
            document.getElementById("view-setup").style.display = "block";
            document.getElementById("view-leaderboard").style.display = "none";
          }
        }
      }

      function switchTab(tab) {
        currentTab = tab;
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        event.target.classList.add("active");
        loadLeaderboardData();
      }

      function showLeaderboardView() {
        document.getElementById("view-setup").style.display = "none";
        document.getElementById("view-leaderboard").style.display = "block";
        document.getElementById("user-info-card").style.display = "block";
        document.getElementById("user-name-display").textContent = userNick;
        document.getElementById("name-edit-panel").style.display = "none";
        document.getElementById(
          "display-group-name"
        ).textContent = `Crew: ${activeGroup}`;
        document.getElementById("player-nick").value = userNick;
        document.getElementById("group-id").value = activeGroup;
        loadLeaderboardData();

        // Show crew selector if multiple crews
        const selector = document.getElementById("crew-selector");
        const dropdown = document.getElementById("crew-dropdown");

        console.log("User groups:", userGroups); // Debug line
        console.log("Active group:", activeGroup); // Debug line

        if (userGroups && userGroups.length > 1) {
          selector.style.display = "block";
          dropdown.innerHTML = userGroups
            .map(
              (g) =>
                `<option value="${g}" ${
                  g === activeGroup ? "selected" : ""
                }>${g}</option>`
            )
            .join("");
        } else {
          selector.style.display = "none";
        }

        // Force reload leaderboard data
        loadLeaderboardData();
        displayUserBadges();
      }

      function loadLeaderboardData() {
        const list = document.getElementById("lb-list");
        list.innerHTML =
          '<div style="text-align:center; padding:20px; color:#64748b;">Establishing connection...</div>';

        if (!db) {
          list.innerHTML =
            '<div style="text-align:center; padding:20px; color:red;">Error: Database not initialized.</div>';
          return;
        }

        // Safety Timeout: If Firebase doesn't respond in 5 seconds, stop waiting.
        const timeout = setTimeout(() => {
          list.innerHTML =
            '<div style="text-align:center; padding:20px; color:orange;">Connection Timeout.<br>Check your Firebase Rules or Internet.</div>';
        }, 5000);

        let path =
          currentTab === "daily"
            ? `scores/${activeGroup}/${new Date().getFullYear()}-${
                new Date().getMonth() + 1
              }-${new Date().getDate()}`
            : `career/${activeGroup}`;

        db.ref(path).once(
          "value",
          (snapshot) => {
            clearTimeout(timeout); // Data arrived, cancel the timeout!
            const data = snapshot.val();

            if (!data) {
              list.innerHTML =
                '<div style="text-align:center; padding:20px; color:#64748b;">No data found yet.<br>Be the first to score!</div>';
              return;
            }

            const sorted = Object.entries(data).sort(([, a], [, b]) => {
              if (currentTab === "daily") {
                // First sort by cash (higher is better)
                if (b.cash !== a.cash) return b.cash - a.cash;
                // If cash is equal, sort by time (lower is better)
                return (a.time || 999999) - (b.time || 999999);
              }
              return (b.totalCash || 0) - (a.totalCash || 0);
            });

            renderList(sorted, currentTab);
          },
          (error) => {
            clearTimeout(timeout);
            console.error("Firebase Read Error:", error);
            list.innerHTML = `<div style="text-align:center; padding:20px; color:red;">Permission Denied.<br>Check Firebase Rules.</div>`;
          }
        );
      }

      function renderList(data, type) {
        const list = document.getElementById("lb-list");
        list.innerHTML = "";

        data.forEach(([nick, stats], index) => {
          const isMe = nick === userNick;
          const rankClass = index < 3 ? `top-${index + 1}` : "";

          let scoreMain, scoreSub;

          if (type === "daily") {
            scoreMain = `$${stats.cash.toLocaleString()}`;
            scoreSub = `${stats.attempts}/6 in ${stats.time}s ${
              stats.intel ? "üîç" : ""
            }`;
          } else {
            scoreMain = `$${(stats.totalCash || 0).toLocaleString()}`;
            scoreSub = `${stats.wins || 0} Wins`;
          }

          let badgeHTML = "";
          if (type === "daily" && index === 0)
            badgeHTML += '<span class="badge">ü•á</span>';
          if (type === "daily" && index === 1)
            badgeHTML += '<span class="badge">ü•à</span>';
          if (type === "daily" && index === 2)
            badgeHTML += '<span class="badge">ü•â</span>';

          const html = `
      <div class="lb-row" style="${
        isMe ? "background:rgba(106, 170, 100, 0.1);" : ""
      }">
          <div class="lb-rank ${rankClass}">${index + 1}</div>
          <div class="lb-user">${nick} ${badgeHTML} ${isMe ? "(You)" : ""}</div>
          <div class="lb-score">
              <div class="lb-score-main">${scoreMain}</div>
              <div class="lb-score-sub">${scoreSub}</div>
          </div>
      </div>
    `;
          list.insertAdjacentHTML("beforeend", html);
        });
      }

      // --- SUBMISSION HELPERS ---

      function submitScoreToFirebase(attempts, cash, time, intelUsed) {
        if (!db || userGroups.length === 0 || !userNick) return;

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const playDate = new Date(currentPlayDate);
        playDate.setHours(0, 0, 0, 0);
        const isToday = today.getTime() === playDate.getTime();
        const dateKey = `${today.getFullYear()}-${
          today.getMonth() + 1
        }-${today.getDate()}`;

        const currentStats =
          JSON.parse(localStorage.getItem("tumblerStats")) || {};

        userGroups.forEach((group) => {
          // Update daily scores ONLY for today's puzzle
          if (isToday) {
            db.ref(`scores/${group}/${dateKey}/${userNick}`).set({
              attempts: attempts,
              cash: cash,
              time: time,
              intel: intelUsed,
              timestamp: Date.now(),
            });
          }

          // ALWAYS update career stats (moved outside the isToday check)
          db.ref(`career/${group}/${userNick}`).update({
            totalCash: currentStats.totalCash || 0,
            wins: currentStats.won || 0,
            lastPlayed: Date.now(),
          });
        });
      }

      function hasPlayedTodayCheck() {
        return window.hasPlayedToday();
      }

      // Calculate and award weekly badges (call this every Sunday at midnight)
      async function calculateWeeklyBadges(crewId) {
        if (!db) return;

        const weekKey = getWeekKey();
        const today = new Date();
        const dateKey = `${today.getFullYear()}-${
          today.getMonth() + 1
        }-${today.getDate()}`;

        try {
          // Get all scores for the crew this week
          const scoresSnapshot = await db.ref(`scores/${crewId}`).once("value");
          const allScores = scoresSnapshot.val();

          if (!allScores) return;

          // Aggregate weekly totals
          const weeklyTotals = {};

          Object.entries(allScores).forEach(([date, dayScores]) => {
            Object.entries(dayScores).forEach(([nick, score]) => {
              if (!weeklyTotals[nick]) {
                weeklyTotals[nick] = {
                  totalCash: 0,
                  bestTime: 999999,
                  plays: 0,
                };
              }
              weeklyTotals[nick].totalCash += score.cash;
              weeklyTotals[nick].bestTime = Math.min(
                weeklyTotals[nick].bestTime,
                score.time
              );
              weeklyTotals[nick].plays++;
            });
          });

          // Sort by total cash
          const sorted = Object.entries(weeklyTotals).sort(
            ([, a], [, b]) => b.totalCash - a.totalCash
          );

          // Find speed king
          const speedKing = Object.entries(weeklyTotals).sort(
            ([, a], [, b]) => a.bestTime - b.bestTime
          )[0];

          // Award badges
          const badges = {
            champion: sorted[0] ? sorted[0][0] : null,
            runnerUp: sorted[1] ? sorted[1][0] : null,
            bronze: sorted[2] ? sorted[2][0] : null,
            speedKing: speedKing ? speedKing[0] : null,
          };

          // Save to Firebase
          await db.ref(`weeklyBadges/${weekKey}/${crewId}`).set(badges);

          console.log(`Badges awarded for ${crewId}:`, badges);
        } catch (e) {
          console.error("Error calculating badges:", e);
        }
      }

      function syncTodaysScore() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        const key = `tumblerGame_${year}-${month}-${day}`;

        const saved = localStorage.getItem(key);
        if (saved) {
          const data = JSON.parse(saved);
          if (data.cashWon > 0) {
            submitScoreToFirebase(
              data.attempts,
              data.cashWon,
              data.solveTime || 0,
              data.intelUsed
            );
          }
        }
      }

      // Expose to window (Safety)
      window.openGroupModal = openGroupModal;
      window.closeGroupModal = closeGroupModal;
      window.joinGroup = joinGroup;
      window.logoutGroup = logoutGroup;
      window.switchTab = switchTab;
      window.submitScoreToFirebase = submitScoreToFirebase;
      window.hasPlayedTodayCheck = hasPlayedTodayCheck;
      window.syncTodaysScore = syncTodaysScore;
      window.switchCrew = switchCrew;
      window.showJoinNewCrew = showJoinNewCrew;
      window.hideJoinNewCrew = hideJoinNewCrew;
      window.startCracking = startCracking;
      window.showNameEdit = showNameEdit;
      window.cancelNameEdit = cancelNameEdit;
      window.saveNewName = saveNewName;
      window.shareCrewInvite = shareCrewInvite;
      window.toggleKeyboardLayout = toggleKeyboardLayout;
      window.calculateWeeklyBadges = calculateWeeklyBadges;
      window.displayUserBadges = displayUserBadges;
      window.buyProtector = buyProtector;
      window.confirmProtectorPurchase = confirmProtectorPurchase;
      window.closeProtectorModal = closeProtectorModal;
      window.buyRecovery = buyRecovery;
      window.confirmRecoveryPurchase = confirmRecoveryPurchase;
      window.closeRecoveryModal = closeRecoveryModal;
    </script>
    <script>
      // Fix mobile keyboard touch issues
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".key").forEach((key) => {
          key.addEventListener(
            "touchstart",
            (e) => {
              e.preventDefault();
            },
            { passive: false }
          );
        });
      });
    </script>
  </body>
</html>
